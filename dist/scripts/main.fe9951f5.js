"use strict";function updateStrokeWidth(a,b){var c=a.originalStrokeWidth||1;if(b||(c+=2),"Group"===a.nodeType){var d=a.find(".mainRect")[0];d&&d.setStrokeWidth(c)}else a.setStrokeWidth(c)}function selectObject(a,b){a.connector&&"drawing"===a.connector.status||(b.selected=!0,updateStrokeWidth(b,!1),a.draw())}function clearSelections(a){var b=a.find("#mainLayer")[0],c=0,d=b.getChildren();for(c=0;c<d.length;c++)d[c].selected=!1,updateStrokeWidth(d[c],!0);a.draw()}function addOutlineStyles(a,b){var c=b||1;a.on("mouseover",function(a){a.target.selected||(a.target.setStrokeWidth(c+2),a.target.getParent().draw())}),a.on("mouseout",function(a){a.target.selected||(a.target.setStrokeWidth(c),a.target.getParent().draw())})}function changeConnectorEndpoints(a,b,c,d){var e=d.x,f=d.y;b.points([0,0,e-c.x,f-c.y]);var g=0,h=0,i=e-c.x,j=f-c.y,k=15,l=Math.atan2(j-h,i-g);b.points([g,h,i,j,i-k*Math.cos(l-Math.PI/6),j-k*Math.sin(l-Math.PI/6),i,j,i-k*Math.cos(l+Math.PI/6),j-k*Math.sin(l+Math.PI/6)])}function updateActiveLineLocation(a,b){if("drawing"===a.connector.status){var c={x:a.connector.line.getX(),y:a.connector.line.getY()},d={x:b.evt.layerX,y:b.evt.layerY};changeConnectorEndpoints(a,a.connector.line,c,d),a.drawScene()}}function startConnector(a,b){var c=new Kinetic.Line({x:a.getPointerPosition().x,y:a.getPointerPosition().y,points:[0,0],stroke:"black",strokeWidth:2});c.connectors={},c.connectors.start=b,c.originalStrokeWidth=2,addOutlineStyles(c,2),a.find("#mainLayer").add(c),c.setZIndex(999),a.connector.status="drawing",a.connector.line=c,c.parent.draw(),a.connector.anchor=b,b.getParent().draggable(!1)}function endConnector(a,b){"drawing"===a.connector.status&&(a.connector.anchor===b||"undefined"==typeof b?a.connector.line.destroy():(a.connector.line.connectors.end=b,b.connections.push(a.connector.line),a.connector.line.connectors.start.connections.push(a.connector.line),a.connector.line.on("mouseup",function(b){clearSelections(a),selectObject(a,b.target)}))),"undefined"!=typeof a.connector.anchor&&a.connector.anchor.getParent().draggable(!0),a.connector={},a.drawScene()}var app=angular.module("sopheAuthorApp",["ngRoute","treeControl","ui.bootstrap","sophe","security"]);app.config(["$routeProvider",function(a){a.when("/",{title:"Home",templateUrl:"views/main.html",controller:"MainCtrl"}).when("/dashboard",{title:"Dashboard",templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}).when("/about",{title:"About",templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/phenotype",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeCtrl"}).when("/phenotype/new",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeCtrl"}).when("/phenotype/:id",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("sophe.draggable",[]).directive("draggable",function(){var a={restrict:"A",link:function(a,b){var c=b[0];c.draggable=!0,c.addEventListener("dragstart",function(a){return a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("Text",c.getElementsByTagName("input")[0].value),this.classList.add("drag"),!1},!1),c.addEventListener("dragend",function(){return this.classList.remove("drag"),!1},!1)}};return a}),angular.module("sophe.droppable",[]).directive("droppable",function(){var a={restrict:"A",scope:{drop:"&"},link:function(a,b){var c=b[0];c.addEventListener("dragover",function(a){return a.dataTransfer.dropEffect="move",a.preventDefault&&a.preventDefault(),this.classList.add("over"),!1},!1),c.addEventListener("dragenter",function(){return this.classList.add("over"),!1},!1),c.addEventListener("dragleave",function(){return this.classList.remove("over"),!1},!1),c.addEventListener("drop",function(b){return b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),this.classList.remove("over"),a.$apply(function(a){var c=a.drop;if("undefined"!=typeof c){var d={config:{x:b.layerX,y:b.layerY,element:JSON.parse(b.dataTransfer.getData("Text"))}};c(d)}}),!1},!1)}};return a}),function(){angular.module("sophe.kinetic",[]).directive("kineticCanvas",[function(){return{restrict:"A",scope:{canvasDetails:"=",connectionStatus:"="},link:function(a,b,c){if(!a.canvasDetails){a.canvasDetails={isdraggable:!0,kineticStageObj:null};var d=c.id;d||(d=Math.random().toString(36).substring(7)),a.canvasDetails.kineticStageObj||(a.canvasDetails.kineticStageObj=new Kinetic.Stage({container:d,width:800,height:600}),a.canvasDetails.kineticStageObj.connector={}),a.canvasDetails.kineticStageObj.container||(a.canvasDetails.kineticStageObj.attrs.container=d);var e=a.canvasDetails.kineticStageObj,f=new Kinetic.Layer({id:"backgroundLayer",draggable:!1});e.add(f),e.backgroundLayer=f;var g=new Kinetic.Layer({id:"mainLayer"});e.add(g),e.mainLayer=g;var h=new Kinetic.Layer;e.add(h),e.tempLayer=h;var i=new Kinetic.Rect({x:0,y:0,width:e.getWidth(),height:e.getHeight(),fill:"white",stroke:"white",strokeWidth:1});f.add(i),f.draw(),i.on("mousemove",function(a){updateActiveLineLocation(e,a)}),i.on("mouseup",function(){endConnector(e,void 0),clearSelections(e)})}}}}])}(),angular.module("sophe.phenotype.toolbar",[]).directive("phenotypeToolbar",[function(){var a={templateUrl:"views/phenotypes/toolbar.html",restrict:"E",replace:!0,scope:!0,link:function(a){a.buttons=[{text:"Save",iconClass:"fa fa-save"},{text:"Export",iconClass:"fa fa-arrow-circle-down"},{spacer:!0},{text:"Copy",iconClass:"fa fa-copy"},{text:"Paste",iconClass:"fa fa-paste"},{text:"Undo",iconClass:"fa fa-undo"},{text:"Redo",iconClass:"fa fa-repeat"}]}};return a}]),angular.module("sophe.elements.phenotype",[]).directive("phenotypeElements",["$rootScope",function(){var a={templateUrl:"views/elements/phenotype.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.dataElements",[]).directive("qdmDataElements",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/dataElements.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.logicalOperators",[]).directive("logicalOperators",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/logicalOperators.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.temporalOperators",[]).directive("temporalOperators",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/temporalOperators.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe",["sophe.kinetic","sophe.draggable","sophe.droppable","sophe.factories.algorithmElement","sophe.elements.qdm.dataElements","sophe.elements.qdm.logicalOperators","sophe.elements.qdm.temporalOperators","sophe.elements.phenotype","sophe.phenotype.toolbar"]),angular.module("sophe.factories.algorithmElement",[]).factory("algorithmElementFactory",function(){function a(a,b){var c=b.canvasDetails.kineticStageObj;a.on("mouseup",function(a){endConnector(c,a.target)}),a.on("mousemove",function(a){updateActiveLineLocation(c,a)}),a.on("mousedown",function(a){endConnector(c,void 0),startConnector(c,a.target)})}function b(a,b){var c=b.canvasDetails.kineticStageObj;a.on("mousemove",function(a){updateActiveLineLocation(c,a)}),a.on("mouseup",function(){endConnector(c,void 0),clearSelections(c),selectObject(c,a)}),a.on("dragstart",function(){a.setZIndex(999),clearSelections(c),selectObject(c,a),a.draw()}),e(a,b)}function c(a,b){a.on("mouseover",function(){document.body.style.cursor="pointer"}),a.on("mouseout",function(){document.body.style.cursor="default",b.$emit("CANVAS-MOUSEOUT")})}function d(a){a.droppable=!0}function e(a,b){var c=b.canvasDetails.kineticStageObj,d=null,e=a;"Group"!==a.nodeType&&(e=a.getParent()),e.on("dragstart",function(){e.moveTo(c.tempLayer),Kinetic.DD.isDragging=!1,c.mainLayer.draw(),Kinetic.DD.isDragging=!0;var a=Kinetic.DD;a.anim.stop(),a.anim.setLayers(c.tempLayer),a.anim.start()}),e.on("dragmove",function(){var a=c.getPointerPosition(),b=c.mainLayer.getIntersection(a);if(!b)return void(d&&(updateStrokeWidth(d,!0),d.getParent().draw(),d=null));if("Text"===b.className){var e=b.getParent().getAllIntersections(a),f=0;for(f=0;f<e.length;f++)if(e[f].droppable){b=e[f];break}}b.droppable&&b!==d&&(d&&updateStrokeWidth(d,!0),d=b,updateStrokeWidth(b,!1),d.getParent().draw())}),e.on("dragend",function(){e.moveTo(c.mainLayer),d&&(updateStrokeWidth(d,!0),d=null,c.mainLayer.draw())})}function f(a,b){("undefined"==typeof a.text||""===a.text)&&(a.text="New Item");var c=new Kinetic.Text(a);return b.add(c),c}function g(a,b){var c=new Kinetic.Rect(a);return b.add(c),c.originalStrokeWidth=a.strokeWidth,c}function h(a,b){var c=new Kinetic.Circle(a);return b.add(c),c.originalStrokeWidth=a.strokeWidth,c}function i(a,b){var c=0;for(c=a.connections.length-1;c>=0;c--){var d=a.connections[c],e={},f={};d.connectors.start===a&&d.setAbsolutePosition(a.getAbsolutePosition()),e={x:d.getPoints()[0],y:d.getPoints()[1]},f={x:d.connectors.end.getAbsolutePosition().x-d.connectors.start.getAbsolutePosition().x,y:d.connectors.end.getAbsolutePosition().y-d.connectors.start.getAbsolutePosition().y},changeConnectorEndpoints(b,d,e,f)}}function j(e,j){var k={x:e&&e.x?e.x:50,y:e&&e.y?e.y:50,width:175,height:200,fill:"#dbeef4",name:"mainRect",stroke:"black",strokeWidth:1},l=new Kinetic.Group({draggable:!0});b(l,j),c(l,j);var m=g(k,l);l.on("dragmove",function(a){if("Group"!==a.target.nodeType)return void console.error("Unsupported object"+a.target);var b=l.getStage();i(a.target.find(".rightConnector")[0],b),i(a.target.find(".leftConnector")[0],b),b.draw()});var n={x:k.x,y:k.y,width:k.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:e.element.name,align:"center",padding:5},o=f(n,l),p={x:k.x+10,y:o.height()+n.y+5,width:k.width-20,height:75,fill:"#EEEEEE",stroke:"#CCCCCC",strokeWidth:1},q=g(p,l);d(q);var r={x:p.x,y:p.y,width:q.width(),height:q.height(),fontFamily:"Calibri",fontSize:14,fill:"gray",text:"Drag and drop clinical terms or value sets here, or search for terms",align:"center",padding:5};f(r,l);var s={x:p.x,y:q.height()+p.y+5,width:p.width,height:p.height,fill:"#EEEEEE",stroke:"#CCCCCC",strokeWidth:1},t=g(s,l);d(t),m.setHeight(t.getY()+t.getHeight()-k.y+10);var u={x:k.x,y:k.y+m.getHeight()/2,width:15,height:15,fill:"white",name:"leftConnector",stroke:"black",strokeWidth:1},v=h(u,l);addOutlineStyles(v),a(v,j),v.connections=[];var w={x:k.x+k.width,y:k.y+m.getHeight()/2,width:15,height:15,fill:"white",name:"rightConnector",stroke:"black",strokeWidth:1},x=h(w,l);addOutlineStyles(x),a(x,j),x.connections=[];var y=j.canvasDetails.kineticStageObj.find("#mainLayer");return y.add(l),y.draw(),m}function k(a,e){var h=new Kinetic.Group({draggable:!0}),i=75;b(h,e),c(h,e);var j={x:a&&a.x?a.x:50,y:a&&a.y?a.y:50,width:175,height:175,fill:"white",name:"eventA",stroke:"gray",strokeWidth:1},k=g(j,h);k.dash([10,5]),k.dashEnabled(!0),d(k);var l={x:j.x,y:j.y,width:j.width,fontFamily:"Calibri",fontSize:18,fill:"black",text:"Event A",align:"center",padding:5},m=f(l,h);f({x:m.getX(),y:m.getY()+m.getHeight()+25,width:j.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:"(Drag and drop a data element here to define the event)",align:"center",padding:5},h),j.x=j.x+j.width+i;var n=g(j,h);n.dash([10,5]),n.dashEnabled(!0),d(n),l.x=j.x,l.y=j.y,l.text="Event B";var o=f(l,h);f({x:o.getX(),y:o.getY()+o.getHeight()+25,width:j.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:"(Drag and drop a data element here to define the event)",align:"center",padding:5},h);var p=e.canvasDetails.kineticStageObj,q=new Kinetic.Line({x:k.getX()+k.getWidth(),y:k.getY()+k.getHeight()/2,points:[0,0],stroke:"black",strokeWidth:2});h.add(q),changeConnectorEndpoints(p,q,{x:0,y:0},{x:i,y:0});var r=p.find("#mainLayer");return r.add(h),r.draw(),h}function l(a,e){var h={x:a&&a.x?a.x:50,y:a&&a.y?a.y:50,width:200,height:200,fill:"#eeeeee",name:"mainRect",stroke:"gray",strokeWidth:1},i=new Kinetic.Group({draggable:!0});b(i,e),c(i,e);var j=g(h,i);j.dash([10,5]),j.dashEnabled(!0),d(j);var k={x:h.x,y:h.y,width:h.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,align:"center",padding:5};f(k,i);var l=e.canvasDetails.kineticStageObj.find("#mainLayer");return l.add(i),l.draw(),i}function m(a,d){var e={x:a&&a.x?a.x:50,y:a&&a.y?a.y:50,width:175,height:100,fill:"#dbeef4",name:"mainRect",stroke:"black",strokeWidth:1},h=new Kinetic.Group({draggable:!0});b(h,d),c(h,d);var i=g(e,h),j={x:e.x,y:e.y,width:e.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,align:"center",padding:5},k=f(j,h);i.setHeight(k.getHeight()+10);var l=d.canvasDetails.kineticStageObj.find("#mainLayer");return l.add(h),l.draw(),h}var n={};return n.addWorkflowObject=function(a,b){if("undefined"==typeof b.canvasDetails)return null;if(!a.element)return console.error("No element definition was provided"),null;var c=null;return c="TemporalOperator"===a.element.type?k(a,b):"DataElement"===a.element.type||"Category"===a.element.type?j(a,b):"LogicalOperator"===a.element.type?l(a,b):m(a,b)},n}),angular.module("sopheAuthorApp").controller("MainCtrl",["$scope",function(a){a.numberOfPhenotypes=0,a.hasPhenotypes=function(){return a.numberOfPhenotypes>0}}]),angular.module("sopheAuthorApp").controller("AboutCtrl",["$scope",function(){}]),angular.module("sopheAuthorApp").controller("PhenotypeCtrl",["$scope","$http","$routeParams","algorithmElementFactory",function(a,b,c,d){function e(a,b){return a.name.localeCompare(b.name)}a.phenotype=c.id,b.get("data/phenotypes.json").success(function(b){a.phenotypes=b.sort(e)}),b.get("data/qdm-categories.json").success(function(b){if(a.dataElements=[],b&&b.results){for(var c=[],d=b.results.bindings,f=0;f<d.length;f++)c.push({name:d[f].categoryLabel.value,uri:d[f].id.value,type:"Category",children:[]});a.dataElements=c.sort(e)}}),b.get("data/qdm-elements.json").success(function(b){if(b&&b.results){for(var c=b.results.bindings,d=0,f=0;f<c.length;f++)for(d=0;d<a.dataElements.length;d++)if(a.dataElements[d].uri===c[f].context.value){a.dataElements[d].children.push({name:c[f].dataElementLabel.value,uri:c[f].id.value,type:"DataElement"});break}for(d=0;d<a.dataElements.length;d++)a.dataElements[d].children=a.dataElements[d].children.sort(e)}}),b.get("data/qdm-logicalOperators.json").success(function(b){if(a.logicalOperators=[],b&&b.results){for(var c=[],d=b.results.bindings,f=0;f<d.length;f++)c.push({name:d[f].logicalOperatorLabel.value,uri:d[f].id.value,type:"LogicalOperator",children:[]});a.logicalOperators=c.sort(e)}}),b.get("data/qdm-temporalOperators.json").success(function(b){if(a.temporalOperators=[],b&&b.results){for(var c=[],d=b.results.bindings,f=0;f<d.length;f++)c.push({name:d[f].temporalOperatorLabel.value,uri:d[f].id.value,type:"TemporalOperator",children:[]});a.temporalOperators=c.sort(e)}}),a.treeOptions={dirSelectable:!1},a.addWorkflowObject=function(b){return d.addWorkflowObject(b,a)}}]),angular.module("security.login.form",[]).controller("LoginFormController",["$scope","security",function(a,b){a.user={},a.authError=null,a.authReason=null,b.getLoginReason()&&(a.authReason=b.isAuthenticated()?"You are not authorized to access this page":"Please log in to continue"),a.login=function(){a.authError=null,b.login(a.user.email,a.user.password).then(function(b){b||(a.authError="Invalid login or password")},function(b){a.authError=b})},a.clearForm=function(){a.user={}},a.cancelLogin=function(){b.cancelLogin()}}]),angular.module("sopheAuthorApp").controller("DashboardCtrl",["$scope",function(a){a.newsItems=[],a.phenotypes=[]}]),angular.module("security",["security.service","security.interceptor","security.login","security.authorization"]),angular.module("security.interceptor",["security.retryQueue"]).factory("securityInterceptor",["$injector","securityRetryQueue",function(a,b){return function(c){return c.then(null,function(d){return 401===d.status&&(c=b.pushRetryFn("unauthorized-server",function(){return a.get("$http")(d.config)})),c})}}]).config(["$httpProvider",function(a){a.responseInterceptors.push("securityInterceptor")}]),angular.module("security.retryQueue",[]).factory("securityRetryQueue",["$q","$log",function(a,b){var c=[],d={onItemAddedCallbacks:[],hasMore:function(){return c.length>0},push:function(a){c.push(a),angular.forEach(d.onItemAddedCallbacks,function(c){try{c(a)}catch(d){b.error("securityRetryQueue.push(retryItem): callback threw an error"+d)}})},pushRetryFn:function(b,c){1===arguments.length&&(c=b,b=void 0);var e=a.defer(),f={reason:b,retry:function(){a.when(c()).then(function(a){e.resolve(a)},function(a){e.reject(a)})},cancel:function(){e.reject()}};return d.push(f),e.promise},retryReason:function(){return d.hasMore()&&c[0].reason},cancelAll:function(){for(;d.hasMore();)c.shift().cancel()},retryAll:function(){for(;d.hasMore();)c.shift().retry()}};return d}]),angular.module("security.service",["security.retryQueue","security.login","ui.bootstrap.modal"]).factory("security",["$http","$q","$location","securityRetryQueue","$modal",function(a,b,c,d,e){function f(a){a=a||"/",c.path(a)}function g(){j||(j=e.open({templateUrl:"views/security/login.html",controller:"LoginFormController"}),j.result.then(i))}function h(a){j&&(j.close(a),j=null)}function i(a){a?d.retryAll():(d.cancelAll(),f())}var j=null;d.onItemAddedCallbacks.push(function(){d.hasMore()&&k.showLogin()});var k={getLoginReason:function(){return d.retryReason()},showLogin:function(){g()},login:function(b,c){var d=a.post("/login",{email:b,password:c});return d.then(function(a){k.currentUser=a.data.user,k.isAuthenticated()&&h(!0)})},cancelLogin:function(){h(!1),f()},logout:function(b){a.post("/logout").then(function(){k.currentUser=null,f(b)})},requestCurrentUser:function(){return k.isAuthenticated()?b.when(k.currentUser):a.get("/current-user").then(function(a){return k.currentUser=a.data.user,k.currentUser})},currentUser:null,isAuthenticated:function(){return null==k.currentUser&&(k.currentUser={firstName:"Test",lastName:"Person"}),!!k.currentUser},isAdmin:function(){return!(!k.currentUser||!k.currentUser.admin)}};return k}]),angular.module("security.authorization",["security.service"]).provider("securityAuthorization",{requireAdminUser:["securityAuthorization",function(a){return a.requireAdminUser()}],requireAuthenticatedUser:["securityAuthorization",function(a){return a.requireAuthenticatedUser()}],$get:["security","securityRetryQueue",function(a,b){var c={requireAuthenticatedUser:function(){var d=a.requestCurrentUser().then(function(){return a.isAuthenticated()?void 0:b.pushRetryFn("unauthenticated-client",c.requireAuthenticatedUser)});return d},requireAdminUser:function(){var d=a.requestCurrentUser().then(function(){return a.isAdmin()?void 0:b.pushRetryFn("unauthorized-client",c.requireAdminUser)});return d}};return c}]}),angular.module("security.login",["security.login.form","security.login.toolbar"]),angular.module("security.login.toolbar",[]).directive("loginToolbar",["security",function(a){var b={templateUrl:"views/security/toolbar.html",restrict:"E",replace:!0,scope:!0,link:function(b){b.isAuthenticated=a.isAuthenticated,b.login=a.showLogin,b.logout=a.logout,b.$watch(function(){return a.currentUser},function(a){b.currentUser=a})}};return b}]);