"use strict";function updateStrokeWidth(a,b){var c=a.originalStrokeWidth||1;if(b||(c+=2),"Group"===a.nodeType){var d=a.find(".mainRect")[0];d&&d.setStrokeWidth(c)}else a.setStrokeWidth(c)}function setConnectorLocation(a,b,c,d,e){var f=b.find("."+c);f.length>0&&f.each(function(a){a.getParent()===b&&(a.setX(d),a.setY(e))})}function updateSizeOfMainRect(a,b,c,d){a.setWidth(c),a.setHeight(d),b.setWidth(c),b.setHeight(d);var e=a.getHeight()/2;setConnectorLocation(a,b,"rightConnector",a.getWidth(),e),setConnectorLocation(a,b,"leftConnector",0,e)}function layoutElementsInContainer(a){var b=a.getChildren(function(a){return"Text"===a.getClassName()})[0],c=a.getChildren(function(a){return"Rect"===a.getClassName()})[0];if(0===a.containedElements.length)return updateSizeOfMainRect(c,a,200,200),void b.setWidth(c.getWidth());for(var d=BORDER,e=b.getHeight()+BORDER,f=0,g=null,h=0;h<a.containedElements.length;h++)g=a.containedElements[h],g.moveTo(a),g.setX(d),g.setY(e),d=d+g.getWidth()+BORDER,f=Math.max(f,e+g.getHeight()+BORDER);updateSizeOfMainRect(c,a,d,f),b.setWidth(c.getWidth())}function findParentElementByName(a,b){for(var c=Kinetic.names[b],d=c.length,e=0;d>e;e++)if(c[e].getParent()===a)return c[e];return null}function changeConnectorEndpoints(a,b,c,d){var e=d.x,f=d.y;b.points([0,0,e-c.x,f-c.y]);var g=0,h=0,i=e-c.x,j=f-c.y,k=15,l=Math.atan2(j-h,i-g);b.points([g,h,i,j,i-k*Math.cos(l-Math.PI/6),j-k*Math.sin(l-Math.PI/6),i,j,i-k*Math.cos(l+Math.PI/6),j-k*Math.sin(l+Math.PI/6)])}function updateConnectedLines(a,b){var c=0;for(c=a.connections.length-1;c>=0;c--){var d=a.connections[c],e={},f={};d.connectors.start===a&&d.setAbsolutePosition(a.getAbsolutePosition()),e={x:d.getPoints()[0],y:d.getPoints()[1]},f={x:d.connectors.end.getAbsolutePosition().x-d.connectors.start.getAbsolutePosition().x,y:d.connectors.end.getAbsolutePosition().y-d.connectors.start.getAbsolutePosition().y},changeConnectorEndpoints(b,d,e,f);var g=d.label;if(null!==g&&"undefined"!=typeof g){g.x(d.connectors.start.getAbsolutePosition().x),g.y(d.connectors.start.getAbsolutePosition().y+5),g.width(f.x-e.x);var h=(f.y-e.y)/(f.x-e.x);g.rotation(Math.atan(h))}}}function _replaceTemporalElement(a,b,c,d,e){var f=findParentElementByName(d,a?"rightConnector":"leftConnector");if(null!==f){b.find(a?".eventALabel":".eventBLabel")[0].destroy(),b.find(a?".eventAText":".eventBText")[0].destroy();var g=b.find(a?".leftConnector":".rightConnector"),h=a?0:1===g.length?0:1;g[h].destroy();var i=b.find(a?".rightConnector":".leftConnector")[h],j=i.connections[0];i.connections=[],i.destroy(),c.destroy(),a?j.connectors.start=f:j.connectors.end=f,f.connections.push(j),updateConnectedLines(f,e)}}function addElementToContainer(a,b,c){var d="Group"===b.nodeType?b:b.parent;if(d)if("TemporalOperator"===d.element.type){var e=b.getParent();b===e.find(".eventA")[0]?_replaceTemporalElement(!0,e,b,c,a):b===b.getParent().find(".eventB")[0]&&_replaceTemporalElement(!1,e,b,c,a)}else"DataElement"===d.element.type||"Category"===d.element.type?console.log("QDM element"):"LogicalOperator"===d.element.type&&(-1===d.containedElements.indexOf(c)&&(d.containedElements.push(c),c.container=d),layoutElementsInContainer(d),a.draw())}function removeElementFromContainer(a,b){if(b&&b.container){var c="Group"===b.container.nodeType?b.container:b.container.parent,d=c.containedElements.indexOf(b);if(0>d)return void console.error("Unable to find element to remove from container");c.containedElements.splice(d,1),b.container=null,layoutElementsInContainer(c),a.mainLayer.draw()}}function selectObject(a,b,c){a.connector&&"drawing"===a.connector.status||(b.selected=!0,updateStrokeWidth(b,!1),a.draw(),c&&c.$root.$broadcast("sophe-element-selected",b))}function _clearSelection(a){var b=0,c=a.getChildren();for(b=0;b<c.length;b++)c[b].selected&&(c[b].selected=!1,updateStrokeWidth(c[b],!0),_clearSelection(c[b]))}function clearSelections(a){var b=a.find("#mainLayer")[0];_clearSelection(b),a.draw()}function addOutlineStyles(a,b){var c=b||1;a.on("mouseover",function(a){a.target.selected||(a.target.setStrokeWidth(c+2),a.target.getParent().draw())}),a.on("mouseout",function(a){a.target.selected||(a.target.setStrokeWidth(c),a.target.getParent().draw())})}function updateActiveLineLocation(a,b){if("drawing"===a.connector.status){var c={x:a.connector.line.getX(),y:a.connector.line.getY()},d={x:b.evt.layerX,y:b.evt.layerY};changeConnectorEndpoints(a,a.connector.line,c,d),a.drawScene()}}function startConnector(a,b){var c=b.getParent(),d=new Kinetic.Line({x:c.getX()+b.getX(),y:c.getY()+b.getY(),points:[0,0],stroke:"black",strokeWidth:2});d.connectors={},d.connectors.start=b,d.originalStrokeWidth=2,addOutlineStyles(d,2),a.find("#mainLayer").add(d),d.setZIndex(999),a.connector.status="drawing",a.connector.line=d,d.parent.draw(),a.connector.anchor=b,b.getParent().draggable(!1)}function endConnector(a,b,c){var d=null;if("drawing"===a.connector.status)if(a.connector.anchor===b||"undefined"==typeof b)a.connector.line.destroy();else{d=a.connector.line,d.connectors.end=b,b.connections.push(d),d.connectors.start.connections.push(d),d.on("mouseup",function(b){clearSelections(a),selectObject(a,b.target,c)});var e={x:d.x(),y:d.y(),width:100,fontFamily:"Calibri",fontSize:12,fill:"black",text:"",align:"center"},f=new Kinetic.Text(e);a.find("#mainLayer").add(f),d.label=f,d.element={name:e.text,uri:"",type:"TemporalOperator"}}return"undefined"!=typeof a.connector.anchor&&a.connector.anchor.getParent().draggable(!0),a.connector={},a.drawScene(),d}function checkCollide(a,b,c,d,e,f){var g=d,h=c,i=c+e,j=d+f;return a>h&&i>a&&b>g&&j>b?!0:!1}function getIntersectingShape(a,b){for(var c=a.getChildren(),d=null,e=null,f=0;f<c.length;f++)if(checkCollide(b.x,b.y,c[f].getX(),c[f].getY(),c[f].getWidth(),c[f].getHeight())){e=c[f],d=e.getChildren();for(var g=0;g<d.length;g++)if(d[g].droppable&&checkCollide(b.x,b.y,d[g].getX()+e.getX(),d[g].getY()+e.getY(),d[g].getWidth(),d[g].getHeight()))return d[g]}return null}var app=angular.module("sopheAuthorApp",["ngRoute","treeControl","ui.bootstrap","sophe","security","ng-context-menu","dynform"]);app.config(["$routeProvider",function(a){a.when("/",{title:"Home",templateUrl:"views/main.html",controller:"MainController"}).when("/dashboard",{title:"Dashboard",templateUrl:"views/dashboard.html",controller:"DashboardController"}).when("/about",{title:"About",templateUrl:"views/about.html",controller:"AboutController"}).when("/phenotype",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeController"}).when("/phenotype/new",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeController"}).when("/phenotype/:id",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeController"}).otherwise({redirectTo:"/"})}]),angular.module("sophe",["sophe.kinetic","sophe.draggable","sophe.droppable","sophe.onlyDigits","sophe.factories.algorithmElement","sophe.factories.kineticStage","sophe.elements.qdm.dataElements","sophe.elements.qdm.logicalOperators","sophe.elements.qdm.temporalOperators","sophe.elements.phenotype","sophe.phenotype.toolbar","sophe.services.qdmAttribute","sophe.services.temporalOperator","sophe.services.qdmElement","sophe.services.logicalOperator"]);var ArrayUtil=ArrayUtil||{};ArrayUtil={findInArray:function(a,b,c){for(var d=0;d<a.length;d++)if(a[d][b]===c)return a[d];return null},sortByName:function(a,b){return a.name.localeCompare(b.name)}};var BORDER=20;angular.module("sophe.services.logicalOperator",[]).service("LogicalOperatorService",["$http","$q",function(a,b){this.load=function(){var c=b.defer();return a.get("data/qdm-logicalOperators.json").success(function(a){c.resolve(a)}).error(function(a,b){c.reject("There was an error: "+b)}),c.promise},this.processValues=function(a){var b=[];if(a&&a.results){for(var c=[],d=a.results.bindings,e=0;e<d.length;e++)c.push({id:d[e].dataElementName.value,name:d[e].logicalOperatorLabel.value,uri:d[e].id.value,type:"LogicalOperator",children:[]});b=c.sort(ArrayUtil.sortByName)}return b},this.addDescriptionForProperties=function(a){for(var b=[{uri:"http://rdf.healthit.gov/qdm/element#And",description:"All of the following criteria must be met"},{uri:"http://rdf.healthit.gov/qdm/element#Or",description:"One or more of the following criteria must be met"},{uri:"http://rdf.healthit.gov/qdm/element#Not",description:"None of the following criteria can be met"}],c=0;c<a.length;c++)a[c].description=ArrayUtil.findInArray(b,"uri",a[c].uri).description}}]),angular.module("sophe.services.qdmAttribute",[]).service("QDMAttributeService",["$http","$q",function(a,b){this._load=function(c){var d=b.defer();return a.get(c).success(function(a){d.resolve(a)}).error(function(a,b){d.reject("There was an error: "+b)}),d.promise},this.loadAll=function(){return this._load("data/test-attribute_specificDatatype.json")},this.loadCategory=function(){return this._load("data/test-attribute_specificDatatype.json")},this.loadElement=function(){return this._load("data/test-attribute_specificDatatype.json")},this.processValues=function(a){var b=[];if(a&&a.results){for(var c=[],d=a.results.bindings,e=0;e<d.length;e++)c.push({id:d[e].dataElementName.value,name:d[e].attributeLabel.value,uri:d[e].id.value,type:d[e].attributeLabel.datatype});b=c}return b}}]),angular.module("sophe.services.qdmElement",["sophe.services.qdmAttribute"]).service("QDMElementService",["$http","$q","QDMAttributeService",function(a,b,c){this.loadCategories=function(){var c=b.defer();return a.get("data/qdm-categories.json").success(function(a){c.resolve(a)}).error(function(a,b){c.reject("There was an error: "+b)}),c.promise},this.loadElements=function(c){var d=b.defer();return a.get("data/qdm-elements.json").success(function(a){d.resolve({categories:c,elements:a})}).error(function(a,b){d.reject("There was an error: "+b)}),d.promise},this.load=function(){return this.loadCategories().then(this.loadElements)},this.processValues=function(a){var b=[],c=0;if(a&&a.categories&&a.categories.results){var d=[],e=a.categories.results.bindings;for(c=0;c<e.length;c++)d.push({id:e[c].dataElementName.value,name:e[c].categoryLabel.value,uri:e[c].id.value,type:"Category",children:[]});b=d.sort(ArrayUtil.sortByName)}if(a&&a.elements&&a.elements.results){var f=a.elements.results.bindings,g=0;for(c=0;c<f.length;c++)for(g=0;g<b.length;g++)if(b[g].uri===f[c].context.value){b[g].children.push({id:f[c].dataElementName.value,name:f[c].dataElementLabel.value,uri:f[c].id.value,type:"DataElement"});break}for(g=0;g<b.length;g++)b[g].children=b[g].children.sort(ArrayUtil.sortByName)}return b},this.getAttributes=function(a){var b=null;return"Category"===a.type?b=c.loadCategory(a.id).then(c.processValues):"DataElement"===a.type&&(b=c.loadElement(a.id).then(c.processValues)),b}}]),angular.module("sophe.services.temporalOperator",[]).service("TemporalOperatorService",["$http","$q",function(a,b){this.load=function(){var c=b.defer();return a.get("data/qdm-temporalOperators.json").success(function(a){c.resolve(a)}).error(function(a,b){c.reject("There was an error: "+b)}),c.promise},this.processValues=function(a){var b=[];if(a&&a.results){for(var c=[],d=a.results.bindings,e=0;e<d.length;e++)c.push({id:d[e].dataElementName.value,name:d[e].temporalOperatorLabel.value,uri:d[e].id.value,type:"TemporalOperator",children:[]});b=c.sort(ArrayUtil.sortByName)}return b},this.buildRelationshipListFromPrefix=function(a,b,c){for(var d=new RegExp("^"+a,"i"),e=0;e<c.length;e++){var f=c[e];if(0===f.name.search(d)){var g=f.name.toLowerCase();b.modifiers.push({id:f.uri,label:g.replace(d,"").trim()})}}},this.buildRelationshipListForProperties=function(a){var b=[{id:"starts",label:"starts",modifiers:[],allowsTimeRange:!0},{id:"ends",label:"ends",modifiers:[],allowsTimeRange:!0},{id:"concurrent with",label:"is concurrent with",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","Concurrent With").uri},{id:"during",label:"occurs during",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","During").uri},{id:"overlaps",label:"overlaps with",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","Overlaps").uri}];return this.buildRelationshipListFromPrefix("starts",b[0],a),this.buildRelationshipListFromPrefix("ends",b[1],a),b},this.convertQDMToSoPhe=function(a,b){var c=ArrayUtil.findInArray(b,"uri",a);if(null===c)return null;var d=c.name,e=new RegExp("^(starts|ends|concurrent with|during)\\s?(.*)","i"),f=e.exec(d),g=null;return null!==f&&(g={base:f[1].toLowerCase(),modifier:f[2].toLowerCase()}),g}}]),angular.module("sophe.draggable",[]).directive("draggable",function(){var a={restrict:"A",link:function(a,b){var c=b[0];c.draggable=!0,c.addEventListener("dragstart",function(a){return a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("Text",c.getElementsByTagName("input")[0].value),this.classList.add("drag"),!1},!1),c.addEventListener("dragend",function(){return this.classList.remove("drag"),!1},!1)}};return a}),angular.module("sophe.droppable",[]).directive("droppable",function(){var a={restrict:"A",scope:{drop:"&"},link:function(a,b){var c=b[0];c.addEventListener("dragover",function(a){return a.dataTransfer.dropEffect="move",a.preventDefault&&a.preventDefault(),this.classList.add("over"),!1},!1),c.addEventListener("dragenter",function(){return this.classList.add("over"),!1},!1),c.addEventListener("dragleave",function(){return this.classList.remove("over"),!1},!1),c.addEventListener("drop",function(b){return b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),this.classList.remove("over"),a.$apply(function(a){var c=a.drop;if("undefined"!=typeof c){var d={config:{x:b.layerX,y:b.layerY,element:JSON.parse(b.dataTransfer.getData("Text"))}};c(d)}}),!1},!1)}};return a}),angular.module("sophe.onlyDigits",[]).directive("onlyDigits",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){d&&d.$parsers.unshift(function(a){var b=a.split("").filter(function(a){return!isNaN(a)&&" "!==a}).join("");return d.$viewValue=b,d.$render(),b})}}}),function(){angular.module("sophe.kinetic",[]).directive("kineticCanvas",["kineticStageFactory",function(a){return{restrict:"A",scope:{canvasDetails:"=",connectionStatus:"="},link:function(b,c,d){a.create(b,d)}}}])}(),angular.module("sophe.phenotype.toolbar",[]).directive("phenotypeToolbar",[function(){var a={templateUrl:"views/phenotypes/toolbar.html",restrict:"E",replace:!0,scope:!0,link:function(a){a.buttons=[{text:"Save",iconClass:"fa fa-save"},{text:"Export",iconClass:"fa fa-arrow-circle-down"},{spacer:!0},{text:"Copy",iconClass:"fa fa-copy"},{text:"Paste",iconClass:"fa fa-paste"},{text:"Undo",iconClass:"fa fa-undo"},{text:"Redo",iconClass:"fa fa-repeat"}]}};return a}]),angular.module("sophe.elements.phenotype",[]).directive("phenotypeElements",["$rootScope",function(){var a={templateUrl:"views/elements/phenotype.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.dataElements",[]).directive("qdmDataElements",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/dataElements.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.logicalOperators",[]).directive("logicalOperators",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/logicalOperators.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.temporalOperators",[]).directive("temporalOperators",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/temporalOperators.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.factories.algorithmElement",[]).factory("algorithmElementFactory",function(){function a(a,b){var c=b.canvasDetails.kineticStageObj;a.on("mouseup",function(a){endConnector(c,a.target,b)}),a.on("mousemove",function(a){updateActiveLineLocation(c,a)}),a.on("mousedown",function(a){endConnector(c,void 0,b),startConnector(c,a.target)})}function b(a,b){var c=b.canvasDetails.kineticStageObj;a.on("mousemove",function(a){updateActiveLineLocation(c,a)}),a.on("mouseup",function(){endConnector(c,void 0,b),clearSelections(c),selectObject(c,a,b)}),a.on("dragstart",function(){a.setZIndex(999),clearSelections(c),selectObject(c,a,b),a.draw()}),e(a,b)}function c(a,b){a.on("mouseover",function(){document.body.style.cursor="pointer"}),a.on("mouseout",function(){document.body.style.cursor="default",b.$emit("CANVAS-MOUSEOUT")})}function d(a,b){a.droppable=!0,a.droppableElementTypes=b}function e(a,b){var c=b.canvasDetails.kineticStageObj,d=null,e=a;"Group"!==a.nodeType&&(e=a.getParent()),e.on("dragstart",function(){e.moveTo(c.tempLayer),Kinetic.DD.isDragging=!1,c.mainLayer.draw(),Kinetic.DD.isDragging=!0;var a=Kinetic.DD;a.anim.stop(),a.anim.setLayers(c.tempLayer),a.anim.start()}),e.on("dragmove",function(a){var b=c.getPointerPosition(),e=getIntersectingShape(c.mainLayer,b);return e?void(e.droppable&&e!==d&&(n(a.target,e)||(document.body.style.cursor="no-drop"),d&&updateStrokeWidth(d,!0),d=e,updateStrokeWidth(e,!1),d.getParent().draw())):(d&&(updateStrokeWidth(d,!0),d.getParent().draw(),d=null),void(document.body.style.cursor="default"))}),e.on("dragend",function(){e.moveTo(c.mainLayer),removeElementFromContainer(c,e),document.body.style.cursor="default",d&&(n(e,d)&&addElementToContainer(c,d,e),updateStrokeWidth(d,!0),d=null,c.mainLayer.draw())})}function f(a,b){("undefined"==typeof a.text||""===a.text)&&(a.text="New Item");var c=new Kinetic.Text(a);return b.add(c),c}function g(a,b){var c=new Kinetic.Rect(a);return b.add(c),c.originalStrokeWidth=a.strokeWidth,c}function h(a,b){var c=new Kinetic.Circle(a);return b.add(c),c.originalStrokeWidth=a.strokeWidth,c}function i(b,c,d,e){e="undefined"!=typeof e?e:!0;var f={x:c.getX(),y:c.getHeight()/2,width:15,height:15,fill:"white",name:"leftConnector",stroke:"black",strokeWidth:1},g=h(f,d);addOutlineStyles(g),a(g,b),g.connections=[];var i={x:c.getX()+c.getWidth(),y:c.getHeight()/2,width:15,height:15,fill:"white",name:"rightConnector",stroke:"black",strokeWidth:1},j=h(i,d);return addOutlineStyles(j),a(j,b),j.connections=[],e&&d.on("dragmove",function(a){if("Group"!==a.target.nodeType)return void console.error("Unsupported object"+a.target);var b=d.getStage();updateConnectedLines(a.target.find(".rightConnector")[0],b),updateConnectedLines(a.target.find(".leftConnector")[0],b),b.find("#mainLayer").draw()}),[g,j]}function j(a,e){var h={x:0,y:0,width:175,height:200,fill:"#dbeef4",name:"mainRect",stroke:"black",strokeWidth:1},j=new Kinetic.Group({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50});b(j,e),c(j,e);var k=g(h,j),l={x:h.x,y:h.y,width:h.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,align:"center",padding:5},m=f(l,j),n={x:h.x+10,y:m.height()+l.y+5,width:h.width-20,height:75,fill:"#EEEEEE",stroke:"#CCCCCC",strokeWidth:1},o=g(n,j);d(o,["ValueSet","Term"]);var p={x:n.x,y:n.y,width:o.width(),height:o.height(),fontFamily:"Calibri",fontSize:14,fill:"gray",text:"Drag and drop clinical terms or value sets here, or search for terms",align:"center",padding:5};f(p,j);var q={x:n.x,y:o.height()+n.y+5,width:n.width,height:n.height,fill:"#EEEEEE",stroke:"#CCCCCC",strokeWidth:1},r=g(q,j);k.setHeight(r.getY()+r.getHeight()-h.y+10),i(e,k,j),j.setWidth(k.getWidth()),j.setHeight(k.getHeight());var s=e.canvasDetails.kineticStageObj.find("#mainLayer");return s.add(j),s.draw(),j}function k(a,e){var h=new Kinetic.Group({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50}),j=75;b(h,e),c(h,e);var k={x:0,y:0,width:175,height:175,fill:"white",name:"eventA",stroke:"gray",strokeWidth:1},l=g(k,h);l.dash([10,5]),l.dashEnabled(!0),d(l,["Category","DataElement","LogicalOperator","Phenotype"]);var m=i(e,l,h),n={x:k.x,y:k.y,width:k.width,fontFamily:"Calibri",fontSize:18,fill:"black",text:"Event A",name:"eventALabel",align:"center",padding:5},o=f(n,h);f({x:o.getX(),y:o.getY()+o.getHeight()+25,width:k.width,fontFamily:"Calibri",fontSize:14,fill:"black",name:"eventAText",text:"(Drag and drop a data element here to define the event)",align:"center",padding:5},h),k.x=k.x+k.width+j,k.name="eventB";var p=g(k,h);p.dash([10,5]),p.dashEnabled(!0),d(p,["Category","DataElement","LogicalOperator","Phenotype"]);var q=i(e,p,h);n.x=k.x,n.y=k.y,n.text="Event B",n.name="eventBLabel";var r=f(n,h);f({x:r.getX(),y:r.getY()+r.getHeight()+25,width:k.width,fontFamily:"Calibri",fontSize:14,fill:"black",name:"eventBText",text:"(Drag and drop a data element here to define the event)",align:"center",padding:5},h);var s=e.canvasDetails.kineticStageObj;startConnector(s,m[1]);var t=endConnector(s,q[0],e);updateConnectedLines(m[1],s),null!==t&&(t.label.setText(a.element.name),t.element=a.element),h.setWidth(p.getX()+p.getWidth()-l.getX()),h.setHeight(l.getHeight());var u=s.find("#mainLayer");return u.add(h),u.draw(),h}function l(a,e){var h={x:0,y:0,width:200,height:200,fill:"#eeeeee",name:"mainRect",stroke:"gray",strokeWidth:1},j=new Kinetic.Group({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50,width:h.width,height:h.height});b(j,e),c(j,e);var k=g(h,j);k.dash([10,5]),k.dashEnabled(!0),d(k,["Category","DataElement","LogicalOperator"]);var l={x:h.x,y:h.y,width:h.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,name:"header",align:"center",padding:5};f(l,j),i(e,k,j),j.containedElements=[];var m=e.canvasDetails.kineticStageObj.find("#mainLayer");return m.add(j),m.draw(),j}function m(a,d){var e={x:0,y:0,width:175,height:100,fill:"#dbeef4",name:"mainRect",stroke:"black",strokeWidth:1},h=new Kinetic.Group({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50});b(h,d),c(h,d);var j=g(e,h),k={x:e.x,y:e.y,width:e.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,align:"center",padding:5},l=f(k,h);j.setHeight(l.getHeight()+30),h.setWidth(j.getWidth()),h.setHeight(j.getHeight()),i(d,j,h);var m=d.canvasDetails.kineticStageObj.find("#mainLayer");return m.add(h),m.draw(),h}function n(a,b){if(!a||!b)return console.error("No drag or drop element was specified"),!1;if(!b.droppable||!b.droppableElementTypes||0===b.droppableElementTypes.length)return console.error("This element is not configured to accept drops"),!1;var c=0;for(c=0;c<b.droppableElementTypes.length;c++)if(b.droppableElementTypes[c]===a.element.type)return!0;return!1}function o(a){var b=a.find(".leftConnector, .rightConnector");b.each(function(a){for(var b=a.connections.length,c=b-1;c>=0;c--)a.connections[c].label.destroy(),a.connections[c].destroy(),delete a.connections[c]}),a.destroy()}var p={};return p.addWorkflowObject=function(a,b){if("undefined"==typeof b.canvasDetails)return console.error("No canvas is defined"),null;if("undefined"==typeof a||null===a||!a.element)return console.error("No element definition was provided"),null;var c=null;return c="TemporalOperator"===a.element.type?k(a,b):"DataElement"===a.element.type||"Category"===a.element.type?j(a,b):"LogicalOperator"===a.element.type?l(a,b):"Phenotype"===a.element.type?m(a,b):m(a,b),c&&(c.element=a.element),c},p.deleteSelectedObjects=function(a){if("undefined"==typeof a.canvasDetails)return null;var b=a.canvasDetails.kineticStageObj;b.mainLayer.get("Group").each(function(a){a.selected===!0&&o(a)}),b.draw()},p.getFirstSelectedItem=function(a){if(!a.canvasDetails||!a.canvasDetails.kineticStageObj)return null;for(var b=a.canvasDetails.kineticStageObj,c=b.find("#mainLayer")[0],d=c.getChildren(),e=0;e<d.length;e++)if(d[e].selected)return d[e];return null},p.allowsDrop=n,p}),angular.module("sophe.factories.kineticStage",[]).factory("kineticStageFactory",function(){var a={};return a.create=function(a,b){if(!a.canvasDetails){a.canvasDetails={isdraggable:!0,kineticStageObj:null};var c=b.id;c||(c=Math.random().toString(36).substring(7)),a.canvasDetails.kineticStageObj||(a.canvasDetails.kineticStageObj=new Kinetic.Stage({container:c,width:800,height:600}),a.canvasDetails.kineticStageObj.connector={}),a.canvasDetails.kineticStageObj.container||(a.canvasDetails.kineticStageObj.attrs.container=c);var d=a.canvasDetails.kineticStageObj,e=new Kinetic.Layer({id:"backgroundLayer",draggable:!1});d.add(e),d.backgroundLayer=e;var f=new Kinetic.Layer({id:"mainLayer"});d.add(f),d.mainLayer=f;var g=new Kinetic.Layer;d.add(g),d.tempLayer=g;var h=new Kinetic.Rect({x:0,y:0,width:d.getWidth(),height:d.getHeight(),fill:"white",stroke:"white",strokeWidth:1});e.add(h),e.draw(),h.on("mousemove",function(a){updateActiveLineLocation(d,a)}),h.on("mouseup",function(){endConnector(d,void 0,a),clearSelections(d),a.$root.$broadcast("sophe-element-selected",null)})}},a}),angular.module("sopheAuthorApp").controller("MainController",["$scope",function(a){a.numberOfPhenotypes=0,a.hasPhenotypes=function(){return a.numberOfPhenotypes>0}}]),angular.module("sopheAuthorApp").controller("AboutController",function(){}),angular.module("sopheAuthorApp").controller("PhenotypeController",["$scope","$http","$routeParams","$modal","algorithmElementFactory","TemporalOperatorService","LogicalOperatorService","QDMElementService",function(a,b,c,d,e,f,g,h){a.phenotype=c.id,a.status={open:[!0,!1,!1,!1]},a.isDeleteDisabled=!0,a.isPropertiesDisabled=!0,b.get("data/phenotypes.json").success(function(b){for(var c=[],d=0;d<b.length;d++)c.push({name:b[d].name,type:"Phenotype"});a.phenotypes=c.sort(ArrayUtil.sortByName)}),h.load().then(h.processValues).then(function(b){a.dataElements=b}),g.load().then(g.processValues).then(function(b){a.logicalOperators=b}),f.load().then(f.processValues).then(function(b){a.temporalOperators=b}),a.treeOptions={dirSelectable:!1},a.$on("sophe-element-selected",function(b,c){a.$apply(function(){a.isPropertiesDisabled=!a.canShowProperties(c),a.isDeleteDisabled=!a.canDelete()})}),a.addWorkflowObject=function(b){return e.addWorkflowObject(b,a)},a.copy=function(){console.log("Copy")},a.canDelete=function(){return null!==e.getFirstSelectedItem(a)},a.delete=function(){e.deleteSelectedObjects(a)},a.paste=function(){console.log("Paste")},a.canShowProperties=function(b){var c=b||e.getFirstSelectedItem(a);return c&&c.element?"TemporalOperator"===c.element.type||"LogicalOperator"===c.element.type||"Category"===c.element.type||"DataElement"===c.element.type:!1},a.showProperties=function(){var b=e.getFirstSelectedItem(a);if(a.canShowProperties(b)){var c=null;"TemporalOperator"===b.element.type?(c=d.open({templateUrl:"views/properties/relationship.html",controller:"RelationshipPropertiesController",size:"lg",resolve:{element:function(){return angular.copy(b.element)},temporalOperators:function(){return a.temporalOperators}}}),c.result.then(function(c){var d=c.relationship.modifier?c.relationship.modifier.id:c.relationship.base.uri;b.element.uri=d,b.element.name=ArrayUtil.findInArray(a.temporalOperators,"uri",d).name,b.element.timeRange=c.timeRange,c.timeRange.comparison&&(b.element.timeRange.comparison=c.timeRange.comparison.name),b.label.setText(b.element.name),b.label.getStage().draw()})):"LogicalOperator"===b.element.type?(c=d.open({templateUrl:"views/properties/logicalOperator.html",controller:"LogicalOperatorPropertiesController",size:"lg",resolve:{element:function(){return angular.copy(b.element)},containedElements:function(){return b.containedElements},logicalOperators:function(){return a.logicalOperators}}}),c.result.then(function(a){b.element=a,findParentElementByName(b,"header").setText(b.element.name),b.getStage().draw()})):("Category"===b.element.type||"DataElement"===b.element.type)&&(c=d.open({templateUrl:"views/properties/qdmElement.html",controller:"QDMElementPropertiesController",size:"lg",resolve:{element:function(){return angular.copy(b.element)}}}),c.result.then(function(){}))}}}]),angular.module("security.login.form",[]).controller("LoginFormController",["$scope","security",function(a,b){a.user={},a.authError=null,a.authReason=null,b.getLoginReason()&&(a.authReason=b.isAuthenticated()?"You are not authorized to access this page":"Please log in to continue"),a.login=function(){a.authError=null,b.login(a.user.email,a.user.password).then(function(b){b||(a.authError="Invalid login or password")},function(b){a.authError=b})},a.clearForm=function(){a.user={}},a.cancelLogin=function(){b.cancelLogin()}}]),angular.module("sopheAuthorApp").controller("DashboardController",["$scope",function(a){a.newsItems=[],a.phenotypes=[]}]),angular.module("sopheAuthorApp").controller("RelationshipPropertiesController",["$scope","$modalInstance","TemporalOperatorService","element","temporalOperators",function(a,b,c,d,e){a.element=d,a.relationship={relationship:{base:"",modifier:"",value:d.uri},timeRange:{comparison:"",start:{value:"",units:""},end:{value:"",units:""}}},a.units=[{name:"minutes",value:"m"},{name:"hours",value:"h"},{name:"days",value:"d"},{name:"weeks",value:"wk"},{name:"months",value:"mo"},{name:"years",value:"a"}],a.comparisons=[{name:"at any time",showStartTime:!1,showEndTime:!1},{name:"between",showStartTime:!0,showEndTime:!0},{name:"exactly",showStartTime:!0,showEndTime:!1},{name:">=",showStartTime:!0,showEndTime:!1},{name:">",showStartTime:!0,showEndTime:!1},{name:"<=",showStartTime:!0,showEndTime:!1},{name:"<",showStartTime:!0,showEndTime:!1}],a.relationships=c.buildRelationshipListForProperties(e);var f=c.convertQDMToSoPhe(d.uri,e);null!=f&&(a.relationship.relationship.base=ArrayUtil.findInArray(a.relationships,"id",f.base),a.relationship.relationship.modifier=ArrayUtil.findInArray(a.relationship.relationship.base.modifiers,"label",f.modifier)),d.timeRange&&(a.relationship.timeRange=d.timeRange,a.relationship.timeRange.comparison=ArrayUtil.findInArray(a.comparisons,"name",d.timeRange.comparison)),a.ok=function(){b.close(a.relationship)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("sopheAuthorApp").controller("LogicalOperatorPropertiesController",["$scope","$modalInstance","LogicalOperatorService","element","containedElements","logicalOperators",function(a,b,c,d,e,f){a.logicalOperators=f,c.addDescriptionForProperties(a.logicalOperators),a.logicalOperator=ArrayUtil.findInArray(a.logicalOperators,"name",d.name),a.containedElements=e,a.ok=function(){b.close(a.logicalOperator)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("sopheAuthorApp").controller("QDMElementPropertiesController",["$scope","$modalInstance","QDMElementService","element",function(a,b,c,d){a.qdmElement=d,a.attributes=[],c.getAttributes(d).then(function(b){a.attributes=b}),a.formData={},a.formTemplate=[{type:"text",label:"First Name",model:"name.first"}],a.ok=function(){b.close(a.qdmElement)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("security",["security.service","security.interceptor","security.login","security.authorization"]),angular.module("security.interceptor",["security.retryQueue"]).factory("securityInterceptor",["$injector","securityRetryQueue",function(a,b){return function(c){return c.then(null,function(d){return 401===d.status&&(c=b.pushRetryFn("unauthorized-server",function(){return a.get("$http")(d.config)})),c})}}]).config(["$httpProvider",function(a){a.responseInterceptors.push("securityInterceptor")}]),angular.module("security.retryQueue",[]).factory("securityRetryQueue",["$q","$log",function(a,b){var c=[],d={onItemAddedCallbacks:[],hasMore:function(){return c.length>0},push:function(a){c.push(a),angular.forEach(d.onItemAddedCallbacks,function(c){try{c(a)}catch(d){b.error("securityRetryQueue.push(retryItem): callback threw an error"+d)}})},pushRetryFn:function(b,c){1===arguments.length&&(c=b,b=void 0);var e=a.defer(),f={reason:b,retry:function(){a.when(c()).then(function(a){e.resolve(a)},function(a){e.reject(a)})},cancel:function(){e.reject()}};return d.push(f),e.promise},retryReason:function(){return d.hasMore()&&c[0].reason},cancelAll:function(){for(;d.hasMore();)c.shift().cancel()},retryAll:function(){for(;d.hasMore();)c.shift().retry()}};return d}]),angular.module("security.service",["security.retryQueue","security.login","ui.bootstrap.modal"]).factory("security",["$http","$q","$location","securityRetryQueue","$modal",function(a,b,c,d,e){function f(a){a=a||"/",c.path(a)
}function g(){j||(j=e.open({templateUrl:"views/security/login.html",controller:"LoginFormController"}),j.result.then(i))}function h(a){j&&(j.close(a),j=null)}function i(a){a?d.retryAll():(d.cancelAll(),f())}var j=null;d.onItemAddedCallbacks.push(function(){d.hasMore()&&k.showLogin()});var k={getLoginReason:function(){return d.retryReason()},showLogin:function(){g()},login:function(b,c){var d=a.post("/login",{email:b,password:c});return d.then(function(a){k.currentUser=a.data.user,k.isAuthenticated()&&h(!0)})},cancelLogin:function(){h(!1),f()},logout:function(b){a.post("/logout").then(function(){k.currentUser=null,f(b)})},requestCurrentUser:function(){return k.isAuthenticated()?b.when(k.currentUser):a.get("/current-user").then(function(a){return k.currentUser=a.data.user,k.currentUser})},currentUser:null,isAuthenticated:function(){return null==k.currentUser&&(k.currentUser={firstName:"Test",lastName:"Person"}),!!k.currentUser},isAdmin:function(){return!(!k.currentUser||!k.currentUser.admin)}};return k}]),angular.module("security.authorization",["security.service"]).provider("securityAuthorization",{requireAdminUser:["securityAuthorization",function(a){return a.requireAdminUser()}],requireAuthenticatedUser:["securityAuthorization",function(a){return a.requireAuthenticatedUser()}],$get:["security","securityRetryQueue",function(a,b){var c={requireAuthenticatedUser:function(){var d=a.requestCurrentUser().then(function(){return a.isAuthenticated()?void 0:b.pushRetryFn("unauthenticated-client",c.requireAuthenticatedUser)});return d},requireAdminUser:function(){var d=a.requestCurrentUser().then(function(){return a.isAdmin()?void 0:b.pushRetryFn("unauthorized-client",c.requireAdminUser)});return d}};return c}]}),angular.module("security.login",["security.login.form","security.login.toolbar"]),angular.module("security.login.toolbar",[]).directive("loginToolbar",["security",function(a){var b={templateUrl:"views/security/toolbar.html",restrict:"E",replace:!0,scope:!0,link:function(b){b.isAuthenticated=a.isAuthenticated,b.login=a.showLogin,b.logout=a.logout,b.$watch(function(){return a.currentUser},function(a){b.currentUser=a})}};return b}]);