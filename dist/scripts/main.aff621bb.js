"use strict";function updateStrokeWidth(a,b){var c=1;if(a.originalStrokeWidth&&(c=Kinetic.Util._isFunction(a.originalStrokeWidth)?a.originalStrokeWidth():a.originalStrokeWidth),b||(c+=2),"Group"===a.nodeType){var d=a.find(".mainRect")[0];d&&d.setStrokeWidth(c)}else a.setStrokeWidth(c)}function setConnectorLocation(a,b,c,d,e){var f=b.find("."+c);f.length>0&&f.each(function(a){a.getParent()===b&&(a.setX(d),a.setY(e))})}function updateSizeOfMainRect(a,b,c,d){a.setWidth(c),a.setHeight(d),b.setWidth(c),b.setHeight(d);var e=a.getHeight()/2;setConnectorLocation(a,b,"rightConnector",a.getWidth(),e),setConnectorLocation(a,b,"leftConnector",0,e)}function layoutElementsInContainer(a){var b=a.getChildren(function(a){return"Text"===a.getClassName()})[0],c=a.getChildren(function(a){return"Rect"===a.getClassName()})[0],d=a.phemaObject().containedElements();if(0===d.length)return updateSizeOfMainRect(c,a,200,200),void b.setWidth(c.getWidth());for(var e=BORDER,f=b.getHeight()+BORDER,g=0,h=null,i=0;i<d.length;i++)h=d[i],h.moveTo(a),h.setX(e),h.setY(f),e=e+h.getWidth()+BORDER,g=Math.max(g,f+h.getHeight()+BORDER);updateSizeOfMainRect(c,a,e,g),b.setWidth(c.getWidth())}function findParentElementByName(a,b){for(var c=Kinetic.names[b],d=c.length,e=0;d>e;e++)if(c[e].getParent()===a)return c[e];return null}function changeConnectorEndpoints(a,b,c,d){var e=d.x,f=d.y;b.points([0,0,e-c.x,f-c.y]);var g=0,h=0,i=e-c.x,j=f-c.y,k=15,l=Math.atan2(j-h,i-g);b.points([g,h,i,j,i-k*Math.cos(l-Math.PI/6),j-k*Math.sin(l-Math.PI/6),i,j,i-k*Math.cos(l+Math.PI/6),j-k*Math.sin(l+Math.PI/6)])}function updateConnectedLines(a,b){var c=0,d=a.connections();for(c=d.length-1;c>=0;c--){var e=d[c],f={},g={},h=e.connectors();h.start===a&&e.setAbsolutePosition(a.getAbsolutePosition()),f={x:e.getPoints()[0],y:e.getPoints()[1]},g={x:h.end.getAbsolutePosition().x-h.start.getAbsolutePosition().x,y:h.end.getAbsolutePosition().y-h.start.getAbsolutePosition().y},changeConnectorEndpoints(b,e,f,g);var i=e.label();if(null!==i&&"undefined"!=typeof i){i.x(h.start.getAbsolutePosition().x),i.y(h.start.getAbsolutePosition().y+5),i.width(g.x-f.x);var j=(g.y-f.y)/(g.x-f.x);i.rotation(Math.atan(j)),e.label(i)}}}function _replaceTemporalElement(a,b,c,d,e){var f=findParentElementByName(d,a?"rightConnector":"leftConnector");if(null!==f){b.find(a?".eventALabel":".eventBLabel")[0].destroy(),b.find(a?".eventAText":".eventBText")[0].destroy();var g=b.find(a?".leftConnector":".rightConnector"),h=a?0:1===g.length?0:1;g[h].destroy();var i=b.find(a?".rightConnector":".leftConnector")[h],j=i.connections()[0];i.connections([]),i.destroy(),c.destroy();var k=j.connectors();a?k.start=f:k.end=f,j.connectors(k);var l=f.connections();l.push(j),f.connections(l),updateConnectedLines(f,e)}}function addElementToContainer(a,b,c){var d="Group"===b.nodeType?b:b.parent;if(d){var e=d.element();if("TemporalOperator"===e.type){var f=b.getParent();b===f.find(".eventA")[0]?_replaceTemporalElement(!0,f,b,c,a):b===b.getParent().find(".eventB")[0]&&_replaceTemporalElement(!1,f,b,c,a)}else if("DataElement"===e.type||"Category"===e.type)console.log("QDM element");else if("LogicalOperator"===e.type){var g=d.phemaObject().containedElements();-1===g.indexOf(c)&&(g.push(c),d.phemaObject().containedElements(g),c.container=d),layoutElementsInContainer(d),a.draw()}}}function allowsDrop(a,b){if(!a||!b)return console.error("No drag or drop element was specified"),!1;if(!b.droppable||!b.droppableElementTypes||0===b.droppableElementTypes.length)return console.error("This element is not configured to accept drops"),!1;var c=0,d=a.element();for(c=0;c<b.droppableElementTypes.length;c++)if(b.droppableElementTypes[c]===d.type)return!0;return!1}function removeElementFromContainer(a,b){if(b&&b.container){var c="Group"===b.container.nodeType?b.container:b.container.parent,d=c.phemaObject().containedElements(),e=d.indexOf(b);if(0>e)return void console.error("Unable to find element to remove from container");d.splice(e,1),c.phemaObject().containedElements(d),b.container=null,layoutElementsInContainer(c),a.mainLayer.draw()}}function selectObject(a,b,c){a.connector&&"drawing"===a.connector.status||(b.selected=!0,updateStrokeWidth(b,!1),a.draw(),c&&c.$root.$broadcast("sophe-element-selected",b))}function _clearSelection(a){var b=0,c=a.getChildren();for(b=0;b<c.length;b++)c[b].selected&&(c[b].selected=!1,updateStrokeWidth(c[b],!0),_clearSelection(c[b]))}function clearSelections(a){var b=a.find("#mainLayer")[0];_clearSelection(b),a.draw()}function addOutlineStyles(a,b){var c=b||1;a.on("mouseover",function(a){a.target.selected||(a.target.setStrokeWidth(c+2),a.target.getParent().draw())}),a.on("mouseout",function(a){a.target.selected||(a.target.setStrokeWidth(c),a.target.getParent().draw())})}function updateActiveLineLocation(a,b){if("drawing"===a.connector.status){var c={x:a.connector.line.getX(),y:a.connector.line.getY()},d={x:b.evt.layerX,y:b.evt.layerY};changeConnectorEndpoints(a,a.connector.line,c,d),a.drawScene()}}function startConnector(a,b){var c=b.getParent(),d=new Kinetic.PhemaConnection({x:c.getX()+b.getX(),y:c.getY()+b.getY(),points:[0,0],stroke:"black",strokeWidth:2}),e={};e.start=b,d.originalStrokeWidth(2),addOutlineStyles(d,2),d.connectors(e),a.find("#mainLayer").add(d),d.setZIndex(999),a.connector.status="drawing",a.connector.line=d,d.parent.draw(),a.connector.anchor=b,b.getParent().draggable(!1)}function endConnector(a,b,c){var d=null;if("drawing"===a.connector.status)if(a.connector.anchor===b||"undefined"==typeof b)a.connector.line.destroy();else{d=a.connector.line;var e=d.connectors();e.end=b;var f=b.connections();f.push(d),b.connections(f),f=e.start.connections(),f.push(d),e.start.connections(f),d.on("mouseup",function(b){clearSelections(a),selectObject(a,b.target,c)}),d.connectors(e);var g={x:d.x(),y:d.y(),width:100,fontFamily:"Calibri",fontSize:12,fill:"black",text:"",align:"center"},h=new Kinetic.Text(g);a.find("#mainLayer").add(h),d.label(h),d.element({name:g.text,uri:"",type:"TemporalOperator"})}return"undefined"!=typeof a.connector.anchor&&a.connector.anchor.getParent().draggable(!0),a.connector={},a.drawScene(),d}function checkCollide(a,b,c,d,e,f){var g=d,h=c,i=c+e,j=d+f;return a>h&&i>a&&b>g&&j>b?!0:!1}function getIntersectingShape(a,b){for(var c=a.getChildren(),d=null,e=null,f=0;f<c.length;f++)if(checkCollide(b.x,b.y,c[f].getX(),c[f].getY(),c[f].getWidth(),c[f].getHeight())){e=c[f],d=e.getChildren();for(var g=0;g<d.length;g++)if(d[g].droppable&&checkCollide(b.x,b.y,d[g].getX()+e.getX(),d[g].getY()+e.getY(),d[g].getWidth(),d[g].getHeight()))return d[g]}return null}var app=angular.module("sopheAuthorApp",["ngResource","ngRoute","treeControl","ui.bootstrap","sophe","security","ng-context-menu","dynform"]);app.config(["$routeProvider",function(a){a.when("/",{title:"Home",templateUrl:"views/main.html",controller:"MainController"}).when("/dashboard",{title:"Dashboard",templateUrl:"views/dashboard.html",controller:"DashboardController"}).when("/about",{title:"About",templateUrl:"views/about.html",controller:"AboutController"}).when("/phenotype",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeController"}).when("/phenotype/new",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeController"}).when("/phenotype/:id",{title:"Phenotypes",templateUrl:"views/phenotypes/edit.html",controller:"PhenotypeController"}).otherwise({redirectTo:"/"})}]),angular.module("sophe",["sophe.config","sophe.kinetic","sophe.draggable","sophe.droppable","sophe.onlyDigits","sophe.factories.algorithmElement","sophe.factories.kineticStage","sophe.elements.qdm.dataElements","sophe.elements.qdm.logicalOperators","sophe.elements.qdm.temporalOperators","sophe.elements.phenotype","sophe.services.qdmAttribute","sophe.services.temporalOperator","sophe.services.qdmElement","sophe.services.library","sophe.services.logicalOperator","sophe.services.url"]),angular.module("sophe.config",[]).constant("environment","dev").constant("dataServiceBaseUrl","api/qdm/");var BaseElement=function(){};BaseElement.prototype={_init:function(){},addConnectionHandler:function(a,b){var c=b.canvasDetails.kineticStageObj;a.on("mouseup",function(a){endConnector(c,a.target,b)}),a.on("mousemove",function(a){updateActiveLineLocation(c,a)}),a.on("mousedown",function(a){endConnector(c,void 0,b),startConnector(c,a.target)})},addStandardEventHandlers:function(a,b){var c=b.canvasDetails.kineticStageObj;a.on("mousemove",function(a){updateActiveLineLocation(c,a)}),a.on("mouseup",function(){endConnector(c,void 0,b),clearSelections(c),selectObject(c,a,b)}),a.on("dragstart",function(){a.setZIndex(999),clearSelections(c),selectObject(c,a,b),a.draw()}),this.setDraggable(a,b)},addCursorEventHandlers:function(a,b){a.on("mouseover",function(){document.body.style.cursor="pointer"}),a.on("mouseout",function(){document.body.style.cursor="default",b.$emit("CANVAS-MOUSEOUT")})},setDroppable:function(a,b){a.droppable=!0,a.droppableElementTypes=b},setDraggable:function(a,b){var c=b.canvasDetails.kineticStageObj,d=null,e=a;"Group"!==a.nodeType&&(e=a.getParent()),e.on("dragstart",function(){e.moveTo(c.tempLayer),Kinetic.DD.isDragging=!1,c.mainLayer.draw(),Kinetic.DD.isDragging=!0;var a=Kinetic.DD;a.anim.stop(),a.anim.setLayers(c.tempLayer),a.anim.start()}),e.on("dragmove",function(a){var b=c.getPointerPosition(),e=getIntersectingShape(c.mainLayer,b);return e?void(e.droppable&&e!==d&&(allowsDrop(a.target,e)||(document.body.style.cursor="no-drop"),d&&updateStrokeWidth(d,!0),d=e,updateStrokeWidth(e,!1),d.getParent().draw())):(d&&(updateStrokeWidth(d,!0),d.getParent().draw(),d=null),void(document.body.style.cursor="default"))}),e.on("dragend",function(){e.moveTo(c.mainLayer),removeElementFromContainer(c,e),document.body.style.cursor="default",d&&(allowsDrop(e,d)&&addElementToContainer(c,d,e),updateStrokeWidth(d,!0),d=null,c.mainLayer.draw())})},createText:function(a,b){("undefined"==typeof a.text||""===a.text)&&(a.text="New Item");var c=new Kinetic.Text(a);return b.add(c),c},createRectangle:function(a,b){var c=new Kinetic.Rect(a);return b.add(c),c.originalStrokeWidth=a.strokeWidth,c},createConnector:function(a,b){var c=new Kinetic.PhemaConnector(a);return b.add(c),c.originalStrokeWidth(a.strokeWidth),c},connectConnectorEvents:function(a){a.on("dragmove",function(b){if("Group"!==b.target.nodeType)return void console.error("Unsupported object"+b.target);var c=a.getStage();updateConnectedLines(b.target.find(".rightConnector")[0],c),updateConnectedLines(b.target.find(".leftConnector")[0],c),c.find("#mainLayer").draw()})},addConnectors:function(a,b,c,d){d="undefined"!=typeof d?d:!0;var e={x:b.getX(),y:b.getHeight()/2,width:15,height:15,fill:"white",name:"leftConnector",stroke:"black",strokeWidth:1},f=this.createConnector(e,c);addOutlineStyles(f),f.connections([]);var g={x:b.getX()+b.getWidth(),y:b.getHeight()/2,width:15,height:15,fill:"white",name:"rightConnector",stroke:"black",strokeWidth:1},h=this.createConnector(g,c);return addOutlineStyles(h),h.connections([]),d&&this.connectConnectorEvents(c),[f,h]},associateReferences:function(a,b){var c=b.canvasDetails.kineticStageObj.mainLayer.find("PhemaConnection");a.find("PhemaConnector").each(function(a){for(var b=a.connections(),d=[],e=0;e<b.length;e++)for(var f=0;f<c.length;f++)if(c[f]._id===b[e].id){d.push(c[f]);var g=c[f].connectors();a._id===g.start.id?g.start=a:a._id===g.end.id?g.end=a:console.log("Invalid connection was found"),c[f].connectors(g);break}a.connections(d)});var d=b.canvasDetails.kineticStageObj.mainLayer.find("Text");c.each(function(a){for(var b=a.label(),c=0;c<d.length;c++)if(d[c]._id===b.id){a.label(d[c]);break}})}};var DataElement=function(){};DataElement.prototype=new BaseElement,DataElement.prototype.connectEvents=function(a,b){this.addStandardEventHandlers(a,b),this.addCursorEventHandlers(a,b);var c=a.find(".termDrop")[0];this.setDroppable(c,["ValueSet","Term"]),this.addConnectionHandler(a.find(".leftConnector")[0],b),this.addConnectionHandler(a.find(".rightConnector")[0],b),this.connectConnectorEvents(a)},DataElement.prototype.containedElements=function(a){return"undefined"==typeof a?this._containedElements:void(this._containedElements=a)},DataElement.prototype.create=function(a,b){var c={x:0,y:0,width:175,height:200,fill:"#dbeef4",name:"mainRect",stroke:"black",strokeWidth:1},d=new Kinetic.PhemaGroup({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50});this._container=d,d.phemaObject(this);var e=this.createRectangle(c,d),f={x:c.x,y:c.y,width:c.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,align:"center",padding:5},g=this.createText(f,d),h={x:c.x+10,y:g.height()+f.y+5,width:c.width-20,height:75,fill:"#EEEEEE",name:"termDrop",stroke:"#CCCCCC",strokeWidth:1},i=this.createRectangle(h,d),j={x:h.x,y:h.y,width:i.width(),height:i.height(),fontFamily:"Calibri",fontSize:14,fill:"gray",text:"Drag and drop clinical terms or value sets here, or search for terms",align:"center",padding:5};this.createText(j,d);var k={x:h.x,y:i.height()+h.y+5,width:h.width,height:h.height,fill:"#EEEEEE",stroke:"#CCCCCC",strokeWidth:1},l=this.createRectangle(k,d);e.setHeight(l.getY()+l.getHeight()-c.y+10),this.addConnectors(b,e,d),this.connectEvents(d,b),d.setWidth(e.getWidth()),d.setHeight(e.getHeight());var m=b.canvasDetails.kineticStageObj.find("#mainLayer");m.add(d),m.draw()},DataElement.prototype.container=function(){return this._container},DataElement.prototype.toObject=function(){var a={className:"DataElement"};return a},DataElement.prototype.load=function(a,b){a.phemaObject();this.container(a),a.phemaObject(this),this.connectEvents(a,b),this.associateReferences(a,b)};var GenericElement=function(){};GenericElement.prototype=new BaseElement,GenericElement.prototype.connectEvents=function(a,b){this.addStandardEventHandlers(a,b),this.addCursorEventHandlers(a,b),this.addConnectionHandler(a.find(".leftConnector")[0],b),this.addConnectionHandler(a.find(".rightConnector")[0],b),this.connectConnectorEvents(a)},GenericElement.prototype.containedElements=function(a){return"undefined"==typeof a?this._containedElements:void(this._containedElements=a)},GenericElement.prototype.create=function(a,b){var c={x:0,y:0,width:175,height:100,fill:"#dbeef4",name:"mainRect",stroke:"black",strokeWidth:1},d=new Kinetic.PhemaGroup({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50});this._container=d,d.phemaObject(this);var e=this.createRectangle(c,d),f={x:c.x,y:c.y,width:c.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,align:"center",padding:5},g=this.createText(f,d);e.setHeight(g.getHeight()+30),d.setWidth(e.getWidth()),d.setHeight(e.getHeight()),this.addConnectors(b,e,d),this.connectEvents(d,b);var h=b.canvasDetails.kineticStageObj.mainLayer;h.add(d),h.draw()},GenericElement.prototype.container=function(){return this._container},GenericElement.prototype.toObject=function(){var a={className:"GenericElement"};return a},GenericElement.prototype.load=function(a,b){a.phemaObject();this.container(a),a.phemaObject(this),this.connectEvents(a,b),this.associateReferences(a,b)};var LogicalOperator=function(){};LogicalOperator.prototype=new BaseElement,LogicalOperator.prototype.connectEvents=function(a,b){this.addStandardEventHandlers(a,b),this.addCursorEventHandlers(a,b),this.setDroppable(a.find(".mainRect")[0],["Category","DataElement","LogicalOperator"]),this.addConnectionHandler(a.find(".leftConnector")[0],b),this.addConnectionHandler(a.find(".rightConnector")[0],b),this.connectConnectorEvents(a)},LogicalOperator.prototype.containedElements=function(a){return"undefined"==typeof a?this._containedElements:void(this._containedElements=a)},LogicalOperator.prototype.create=function(a,b){var c={x:0,y:0,width:200,height:200,fill:"#eeeeee",name:"mainRect",stroke:"gray",strokeWidth:1},d=new Kinetic.PhemaGroup({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50,width:c.width,height:c.height});this._container=d,d.phemaObject(this);var e=this.createRectangle(c,d);e.dash([10,5]),e.dashEnabled(!0);var f={x:c.x,y:c.y,width:c.width,fontFamily:"Calibri",fontSize:14,fill:"black",text:a.element.name,name:"header",align:"center",padding:5};this.createText(f,d),this.addConnectors(b,e,d),this.connectEvents(d,b),this.containedElements([]);var g=b.canvasDetails.kineticStageObj.mainLayer;g.add(d),g.draw()},LogicalOperator.prototype.container=function(){return this._container},LogicalOperator.prototype.toObject=function(){var a={};a.containedElements=[];for(var b=0;b<this._containedElements.length;b++)a.containedElements.push({id:this._containedElements[b]._id});return a.className="LogicalOperator",a},LogicalOperator.prototype.load=function(a,b){var c=a.phemaObject();this.containedElements(c.containedElements),this.container(a),a.phemaObject(this),this.connectEvents(a,b),this.associateReferences(a,b)};var TemporalOperator=function(){};TemporalOperator.prototype=new BaseElement,TemporalOperator.prototype.connectEvents=function(a,b){var c=["Category","DataElement","LogicalOperator","Phenotype"];this.addStandardEventHandlers(a,b),this.addCursorEventHandlers(a,b);var d=a.find(".eventA")[0],e=0;d&&(e=1,this.setDroppable(d,c),this.addConnectionHandler(a.find(".leftConnector")[0],b),this.addConnectionHandler(a.find(".rightConnector")[0],b));var f=a.find(".eventB")[0];f&&(this.setDroppable(a.find(".eventB")[0],c),this.addConnectionHandler(a.find(".leftConnector")[e],b),this.addConnectionHandler(a.find(".rightConnector")[e],b)),this.connectConnectorEvents(a)},TemporalOperator.prototype.containedElements=function(a){return"undefined"==typeof a?this._containedElements:void(this._containedElements=a)},TemporalOperator.prototype.create=function(a,b){var c=new Kinetic.PhemaGroup({draggable:!0,x:a&&a.x?a.x:50,y:a&&a.y?a.y:50});this._container=c,c.phemaObject(this);var d=75,e={x:0,y:0,width:175,height:175,fill:"white",name:"eventA",stroke:"gray",strokeWidth:1},f=this.createRectangle(e,c);f.dash([10,5]),f.dashEnabled(!0);var g=this.addConnectors(b,f,c),h={x:e.x,y:e.y,width:e.width,fontFamily:"Calibri",fontSize:18,fill:"black",text:"Event A",name:"eventALabel",align:"center",padding:5},i=this.createText(h,c);this.createText({x:i.getX(),y:i.getY()+i.getHeight()+25,width:e.width,fontFamily:"Calibri",fontSize:14,fill:"black",name:"eventAText",text:"(Drag and drop a data element here to define the event)",align:"center",padding:5},c),e.x=e.x+e.width+d,e.name="eventB";var j=this.createRectangle(e,c);j.dash([10,5]),j.dashEnabled(!0);var k=this.addConnectors(b,j,c);h.x=e.x,h.y=e.y,h.text="Event B",h.name="eventBLabel";var l=this.createText(h,c);this.createText({x:l.getX(),y:l.getY()+l.getHeight()+25,width:e.width,fontFamily:"Calibri",fontSize:14,fill:"black",name:"eventBText",text:"(Drag and drop a data element here to define the event)",align:"center",padding:5},c);var m=b.canvasDetails.kineticStageObj;startConnector(m,g[1]);var n=endConnector(m,k[0],b);updateConnectedLines(g[1],m),null!==n&&(n.label().setText(a.element.name),n.element(a.element)),this.connectEvents(c,b),c.setWidth(j.getX()+j.getWidth()-f.getX()),c.setHeight(f.getHeight());var o=m.find("#mainLayer");o.add(c),o.draw()},TemporalOperator.prototype.container=function(){return this._container},TemporalOperator.prototype.toObject=function(){var a={className:"TemporalOperator"};return a},TemporalOperator.prototype.load=function(a,b){a.phemaObject();this.container(a),a.phemaObject(this),this.connectEvents(a,b),this.associateReferences(a,b)}(function(){Kinetic.PhemaConnection=function(a){this._initElement(a)},Kinetic.PhemaConnection.prototype={_initElement:function(a){Kinetic.Line.call(this,a),this.className="PhemaConnection"},toObject:function(){var a,b,c,d,e=Kinetic.Util,f={},g=this.getAttrs();f.attrs={};for(a in g)b=g[a],"connectors"===a?f.attrs[a]={start:{id:b.start._id},end:{id:b.end._id}}:"label"===a?f.attrs[a]={id:b._id}:e._isFunction(b)||e._isElement(b)||e._isObject(b)&&e._hasMethods(b)||(c=this[a],delete g[a],d=c?c.call(this):null,g[a]=b,d!==b&&(f.attrs[a]=b));return f.id=this._id,f.className=this.getClassName(),f}},Kinetic.Util.extend(Kinetic.PhemaConnection,Kinetic.Line),Kinetic.Factory.addGetterSetter(Kinetic.PhemaConnection,"originalStrokeWidth",1),Kinetic.Factory.addGetterSetter(Kinetic.PhemaConnection,"connectors",null),Kinetic.Factory.addGetterSetter(Kinetic.PhemaConnection,"label",null),Kinetic.Factory.addGetterSetter(Kinetic.PhemaConnection,"element",null)})(),function(){Kinetic.PhemaConnector=function(a){this._initElement(a)},Kinetic.PhemaConnector.prototype={_initElement:function(a){Kinetic.Circle.call(this,a),this.className="PhemaConnector"},toObject:function(){var a,b,c,d,e=Kinetic.Util,f={},g=this.getAttrs();f.attrs={};for(a in g)if(b=g[a],"connections"===a){f.attrs[a]=[];for(var h=0;h<b.length;h++)f.attrs[a].push({id:b[h]._id})}else e._isFunction(b)||e._isElement(b)||e._isObject(b)&&e._hasMethods(b)||(c=this[a],delete g[a],d=c?c.call(this):null,g[a]=b,d!==b&&(f.attrs[a]=b));return f.id=this._id,f.className=this.getClassName(),f}},Kinetic.Util.extend(Kinetic.PhemaConnector,Kinetic.Circle),Kinetic.Factory.addGetterSetter(Kinetic.PhemaConnector,"originalStrokeWidth",1),Kinetic.Factory.addGetterSetter(Kinetic.PhemaConnector,"connections",[])}(),function(){Kinetic.PhemaGroup=function(a){this._initElement(a)},Kinetic.PhemaGroup.prototype={_initElement:function(a){this.className="PhemaGroup",Kinetic.Group.call(this,a)},toObject:function(){var a,b,c,d,e=Kinetic.Util,f={},g=this.getAttrs();f.attrs={};for(a in g)b=g[a],"phemaObject"===a?f.attrs[a]=b.toObject():e._isFunction(b)||e._isElement(b)||e._isObject(b)&&e._hasMethods(b)||(c=this[a],delete g[a],d=c?c.call(this):null,g[a]=b,d!==b&&(f.attrs[a]=b));f.id=this._id,f.className=this.getClassName(),f.children=[];for(var h=this.getChildren(),i=h.length,j=0;i>j;j++){var k=h[j];f.children.push(k.toObject())}return f}},Kinetic.Util.extend(Kinetic.PhemaGroup,Kinetic.Group),Kinetic.Factory.addGetterSetter(Kinetic.PhemaGroup,"element",null),Kinetic.Factory.addGetterSetter(Kinetic.PhemaGroup,"phemaObject",null)}();var ArrayUtil=ArrayUtil||{};ArrayUtil={findInArray:function(a,b,c){for(var d=0;d<a.length;d++)if(a[d][b]===c)return a[d];return null},findInArrayOrChildren:function(a,b,c){var d=ArrayUtil.findInArray(a,b,c);if(null===d)for(var e=null,f=0;f<a.length&&(e=a[f].children,!(e&&e.length>0&&(d=ArrayUtil.findInArray(a[f].children,b,c),null!==d)));f++);return d},sortByName:function(a,b){return a.name.localeCompare(b.name)}};var BORDER=20;angular.module("sophe.services.library",["sophe.services.url","ngResource"]).service("LibraryService",["$resource","$q","URLService",function(a,b,c){this.load=function(){var d=b.defer();return a(c.getLibraryURL()).query(function(a){d.resolve(a)},function(a,b){d.reject("There was an error: "+b)}),d.promise},this.processValues=function(a){for(var b=[],c=[],d=0;d<a.length;d++)c.push({name:a[d].name,type:"Phenotype"});return b=c.sort(ArrayUtil.sortByName)}}]),angular.module("sophe.services.logicalOperator",["sophe.services.url","ngResource"]).service("LogicalOperatorService",["$resource","$q","URLService",function(a,b,c){this.load=function(){var d=b.defer();return a(c.getDataServiceURL("logicalOperators")).get(function(a){d.resolve(a)},function(a,b){d.reject("There was an error: "+b)}),d.promise},this.processValues=function(a){var b=[];if(a&&a.results){for(var c=[],d=a.results.bindings,e=0;e<d.length;e++)c.push({id:d[e].dataElementName.value,name:d[e].logicalOperatorLabel.value,uri:d[e].id.value,type:"LogicalOperator",children:[]});b=c.sort(ArrayUtil.sortByName)}return b},this.addDescriptionForProperties=function(a){for(var b=[{uri:"http://rdf.healthit.gov/qdm/element#And",description:"All of the following criteria must be met"},{uri:"http://rdf.healthit.gov/qdm/element#Or",description:"One or more of the following criteria must be met"},{uri:"http://rdf.healthit.gov/qdm/element#Not",description:"None of the following criteria can be met"}],c=0;c<a.length;c++)a[c].description=ArrayUtil.findInArray(b,"uri",a[c].uri).description}}]),angular.module("sophe.services.qdmAttribute",["sophe.services.url","ngResource"]).service("QDMAttributeService",["URLService","$resource","$q",function(a,b,c){this._load=function(a,d){var e=c.defer();return b(a).get(d,function(a){e.resolve(a)},function(a,b){e.reject("There was an error: "+b)}),e.promise},this.loadAll=function(){return this._load(a.getDataServiceURL("attributes"))},this.loadCategory=function(b){return this._load(a.getDataServiceURL("category/:category/attributes"),{category:b})},this.loadElement=function(b){return this._load(a.getDataServiceURL("dataElement/:dataElement/attributes"),{dataElement:b})},this.processValues=function(a){var b=[];if(a&&a.results){for(var c=[],d=a.results.bindings,e=0;e<d.length;e++)c.push({id:d[e].dataElementName.value,name:d[e].attributeLabel.value,uri:d[e].id.value,type:d[e].attributeLabel.datatype});b=c}return b},this.translateQDMToForm=function(a){var b={type:"text",label:a.name,model:a.id};return"Reason"===a.id?b.type="select":"http://www.w3.org/2001/XMLSchema#date"===a.type?b.type="date":"http://www.w3.org/2001/XMLSchema#dateTime"===a.type&&(b.type="datetime"),b}}]),angular.module("sophe.services.qdmElement",["sophe.services.qdmAttribute","sophe.services.url","ngResource"]).service("QDMElementService",["$resource","$q","QDMAttributeService","URLService",function(a,b,c,d){this.loadCategories=function(){var c=b.defer();return a(d.getDataServiceURL("categories")).get(function(a){c.resolve(a)},function(a,b){c.reject("There was an error: "+b)}),c.promise},this.loadElements=function(c){var e=b.defer();return a(d.getDataServiceURL("elements")).get(function(a){e.resolve({categories:c,elements:a})},function(a,b){e.reject("There was an error: "+b)}),e.promise},this.load=function(){return this.loadCategories().then(this.loadElements)},this.processValues=function(a){var b=[],c=0;if(a&&a.categories&&a.categories.results){var d=[],e=a.categories.results.bindings;for(c=0;c<e.length;c++)d.push({id:e[c].dataElementName.value,name:e[c].categoryLabel.value,uri:e[c].id.value,type:"Category",children:[]});b=d.sort(ArrayUtil.sortByName)}if(a&&a.elements&&a.elements.results){var f=a.elements.results.bindings,g=0;for(c=0;c<f.length;c++)for(g=0;g<b.length;g++)if(b[g].uri===f[c].context.value){b[g].children.push({id:f[c].dataElementName.value,name:f[c].dataElementLabel.value,uri:f[c].id.value,type:"DataElement"});break}for(g=0;g<b.length;g++)b[g].children=b[g].children.sort(ArrayUtil.sortByName)}return b},this.getAttributes=function(a){var b=null;return"Category"===a.type?b=c.loadCategory(a.id).then(c.processValues):"DataElement"===a.type&&(b=c.loadElement(a.id).then(c.processValues)),b}}]),angular.module("sophe.services.temporalOperator",["sophe.services.url","ngResource"]).filter("advancedFilter",function(){return function(a,b){if(a){var c=new RegExp("Or Concurrent With","i"),d=a.filter(function(a){return b||-1===a.label.search(c)});return d}}}).service("TemporalOperatorService",["$resource","$q","URLService",function(a,b,c){this.load=function(){var d=b.defer();return a(c.getDataServiceURL("temporalOperators")).get(function(a){d.resolve(a)},function(a,b){d.reject("There was an error: "+b)}),d.promise},this.processValues=function(a){var b=[{id:"Before",linkRegex:new RegExp("^[a-z]+\\sbefore","i"),name:"Before",uri:"http://projectphema.org/TemporalOperator#Before",type:"TemporalOperator",children:[]},{id:"After",linkRegex:new RegExp("^[a-z]+\\safter","i"),name:"After",uri:"http://projectphema.org/TemporalOperator#After",type:"TemporalOperator",children:[]},{id:"During",uri:"http://rdf.healthit.gov/qdm/element#During"},{id:"ConcurrentWith",uri:"http://rdf.healthit.gov/qdm/element#ConcurrentWith"},{id:"Overlaps",uri:"http://rdf.healthit.gov/qdm/element#Overlaps"}];if(a&&a.results){var c,d=a.results.bindings;for(c=0;c<d.length;c++){var e={id:d[c].dataElementName.value,name:d[c].temporalOperatorLabel.value,uri:d[c].id.value,type:"TemporalOperator",children:[]},f=ArrayUtil.findInArray(b,"uri",d[c].id.value);if(f)f.id=e.id,f.name=e.name,f.type=e.type,f.children=e.children;else for(var g=0;g<b.length;g++)b[g].linkRegex&&0===e.name.search(b[g].linkRegex)&&b[g].children.push(e)}for(c=0;c<b.length;c++)b[c].children&&(b[c].children=b[c].children.sort(ArrayUtil.sortByName))}return b},this.buildRelationshipListFromPrefix=function(a,b,c){for(var d=new RegExp("^"+a,"i"),e=0;e<c.length;e++){var f=c[e];if(0===f.name.search(d)){var g=f.name.toLowerCase();b.modifiers.push({id:f.uri,label:g.replace(d,"").trim()})}this.buildRelationshipListFromPrefix(a,b,c[e].children)}},this.buildRelationshipListForProperties=function(a){var b=[{id:"after",label:"occurs after",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","After").uri},{id:"before",label:"occurs before",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","Before").uri},{id:"starts",label:"starts",modifiers:[],allowsTimeRange:!0},{id:"ends",label:"ends",modifiers:[],allowsTimeRange:!0},{id:"concurrent with",label:"is concurrent with",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","Concurrent With").uri},{id:"during",label:"occurs during",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","During").uri},{id:"overlaps",label:"overlaps with",modifiers:[],allowsTimeRange:!1,uri:ArrayUtil.findInArray(a,"name","Overlaps").uri}];return this.buildRelationshipListFromPrefix("starts",b[2],a),this.buildRelationshipListFromPrefix("ends",b[3],a),b},this.convertQDMToSoPhe=function(a,b){var c=ArrayUtil.findInArrayOrChildren(b,"uri",a);if(null===c)return null;var d=c.name,e=new RegExp("^(starts|ends|concurrent with|during|before|after)\\s?(.*)","i"),f=e.exec(d),g=null;return null!==f&&(g={base:f[1].toLowerCase(),modifier:f[2].toLowerCase()}),g}}]),angular.module("sophe.services.url",["sophe.config"]).service("URLService",["environment","dataServiceBaseUrl",function(a,b){this.getDataServiceURL=function(c){if("local"===a||"@@"===a.substring(0,2))return/attributes/.test(c)?"data/test-attribute_specificDatatype.json":"data/qdm-"+c+".json";var d=b+c;return d},this.getLibraryURL=function(c){if("local"===a||"dev"===a)return"data/phenotypes.json";var d=b+c;return d}}]),angular.module("sophe.draggable",[]).directive("draggable",function(){var a={restrict:"A",link:function(a,b){var c=b[0];c.draggable=!0,c.addEventListener("dragstart",function(a){return a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("Text",c.getElementsByTagName("input")[0].value),this.classList.add("drag"),!1},!1),c.addEventListener("dragend",function(){return this.classList.remove("drag"),!1},!1)}};return a}),angular.module("sophe.droppable",[]).directive("droppable",function(){var a={restrict:"A",scope:{drop:"&"},link:function(a,b){var c=b[0];c.addEventListener("dragover",function(a){return a.dataTransfer.dropEffect="move",a.preventDefault&&a.preventDefault(),this.classList.add("over"),!1},!1),c.addEventListener("dragenter",function(){return this.classList.add("over"),!1},!1),c.addEventListener("dragleave",function(){return this.classList.remove("over"),!1},!1),c.addEventListener("drop",function(b){return b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),this.classList.remove("over"),a.$apply(function(a){var c=a.drop;if("undefined"!=typeof c){var d={config:{x:b.layerX,y:b.layerY,element:JSON.parse(b.dataTransfer.getData("Text"))}};c(d)}}),!1},!1)}};return a}),angular.module("sophe.onlyDigits",[]).directive("onlyDigits",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){d&&d.$parsers.unshift(function(a){var b=a.split("").filter(function(a){return!isNaN(a)&&" "!==a}).join("");return d.$viewValue=b,d.$render(),b})}}}),function(){angular.module("sophe.kinetic",[]).directive("kineticCanvas",["$window","kineticStageFactory",function(a,b){return{restrict:"A",scope:{canvasDetails:"=",connectionStatus:"="},link:function(c,d,e){b.create(c,e),c.initialElementHeight=$(d).height(),c.initialWindowHeight=a.innerHeight;var f=function(a,b,c){for(var d=$(a).children(),e=0;e<d.length;e++)f(d[e],b,c);
$(a).height(c),$(a).width(b),$(a)[0].height=c,$(a)[0].width=b};c.onResize=function(){d.windowHeight=c.initialElementHeight+(a.innerHeight-c.initialWindowHeight)+5,d.windowWidth=a.innerWidth-$(d).offset().left-20,f(d,d.windowWidth,d.windowHeight),c.canvasDetails.kineticStageObj&&(c.canvasDetails.kineticStageObj.setWidth(d.windowWidth),c.canvasDetails.kineticStageObj.setHeight(d.windowHeight),c.canvasDetails.kineticStageObj.drawScene())},c.onResize(),angular.element(a).bind("resize",function(){c.onResize()})}}}])}(),angular.module("sophe.elements.phenotype",[]).directive("phenotypeElements",["$rootScope",function(){var a={templateUrl:"views/elements/phenotype.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.dataElements",[]).directive("qdmDataElements",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/dataElements.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.logicalOperators",[]).directive("logicalOperators",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/logicalOperators.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.elements.qdm.temporalOperators",[]).directive("temporalOperators",["$rootScope",function(){var a={templateUrl:"views/elements/qdm/temporalOperators.html",restrict:"A",replace:!0,scope:!0,link:function(){}};return a}]),angular.module("sophe.factories.algorithmElement",[]).factory("algorithmElementFactory",function(){function a(a,b){var c=new DataElement;return c.create(a,b),c.container()}function b(a,b){var c=new TemporalOperator;return c.create(a,b),c.container()}function c(a,b){var c=new LogicalOperator;return c.create(a,b),c.container()}function d(a,b){var c=new GenericElement;return c.create(a,b),c.container()}function e(a){var b=a.find(".leftConnector, .rightConnector");b.each(function(a){for(var b=a.connections(),c=b.length,d=c-1;d>=0;d--)b[d].label.destroy(),b[d].destroy(),delete b[d];a.connections([])}),a.destroy()}var f={};return f.addWorkflowObject=function(e,f){if("undefined"==typeof f.canvasDetails)return console.error("No canvas is defined"),null;if("undefined"==typeof e||null===e||!e.element)return console.error("No element definition was provided"),null;var g=null;return g="TemporalOperator"===e.element.type?b(e,f):"DataElement"===e.element.type||"Category"===e.element.type?a(e,f):"LogicalOperator"===e.element.type?c(e,f):"Phenotype"===e.element.type?d(e,f):d(e,f),g&&g.element(e.element),g},f.loadFromDefinition=function(a,b){if("undefined"==typeof a.canvasDetails)return null;var c=a.canvasDetails.kineticStageObj,d=c.find("#mainLayer")[0];d=Kinetic.Node.create(b),c.add(d),c.mainLayer=d,c.mainLayer.get("Group").each(function(b){var c=b.element();if("TemporalOperator"===c.type){var d=new TemporalOperator;d.load(b,a)}else if("DataElement"===c.type||"Category"===c.type){var e=new DataElement;e.load(b,a)}else if("LogicalOperator"===c.type){var f=new LogicalOperator;f.load(b,a)}else if("Phenotype"===c.type){var g=new GenericElement;g.load(b,a)}else{var h=new GenericElement;h.load(b,a)}})},f.deleteSelectedObjects=function(a){if("undefined"==typeof a.canvasDetails)return null;var b=a.canvasDetails.kineticStageObj;b.mainLayer.get("Group").each(function(a){a.selected===!0&&e(a)}),b.draw()},f.getFirstSelectedItem=function(a){if(!a.canvasDetails||!a.canvasDetails.kineticStageObj)return null;for(var b=a.canvasDetails.kineticStageObj,c=b.find("#mainLayer")[0],d=c.getChildren(),e=0;e<d.length;e++)if(d[e].selected)return d[e];return null},f}),angular.module("sophe.factories.kineticStage",[]).factory("kineticStageFactory",function(){var a={};return a.create=function(a,b){if(!a.canvasDetails){a.canvasDetails={isdraggable:!0,kineticStageObj:null};var c=b.id;c||(c=Math.random().toString(36).substring(7)),a.canvasDetails.kineticStageObj||(a.canvasDetails.kineticStageObj=new Kinetic.Stage({container:c,width:800,height:600}),a.canvasDetails.kineticStageObj.connector={}),a.canvasDetails.kineticStageObj.container||(a.canvasDetails.kineticStageObj.attrs.container=c);var d=a.canvasDetails.kineticStageObj,e=new Kinetic.Layer({id:"backgroundLayer",draggable:!1});d.add(e),d.backgroundLayer=e;var f=new Kinetic.Layer({id:"mainLayer"});d.add(f),d.mainLayer=f;var g=new Kinetic.Layer;d.add(g),d.tempLayer=g;var h=new Kinetic.Rect({x:0,y:0,width:d.getWidth(),height:d.getHeight(),fill:"white",stroke:"white",strokeWidth:1});e.add(h),e.draw(),h.on("mousemove",function(a){updateActiveLineLocation(d,a)}),h.on("mouseup",function(){endConnector(d,void 0,a),clearSelections(d),a.$root.$broadcast("sophe-element-selected",null)})}},a}),angular.module("sopheAuthorApp").controller("MainController",["$scope",function(a){a.numberOfPhenotypes=0,a.hasPhenotypes=function(){return a.numberOfPhenotypes>0}}]),angular.module("sopheAuthorApp").controller("AboutController",["$scope",function(){}]),angular.module("sopheAuthorApp").controller("PhenotypeController",["$scope","$http","$routeParams","$modal","algorithmElementFactory","TemporalOperatorService","LogicalOperatorService","QDMElementService","LibraryService",function(a,b,c,d,e,f,g,h,i){a.phenotype=c.id,a.status={open:[!0,!1,!1,!1]},a.isDeleteDisabled=!0,a.isPropertiesDisabled=!0;var j=new RegExp("[a-z]+\\sConcurrent With","i");a.temporalFilter=function(a){return a?-1===a.name.search(j):void 0},i.load().then(i.processValues).then(function(b){a.phenotypes=b}),h.load().then(h.processValues).then(function(b){a.dataElements=b}),g.load().then(g.processValues).then(function(b){a.logicalOperators=b}),f.load().then(f.processValues).then(function(b){a.temporalOperators=b}),a.treeOptions={dirSelectable:!1},a.$on("sophe-element-selected",function(b,c){a.$apply(function(){a.isPropertiesDisabled=!a.canShowProperties(c),a.isDeleteDisabled=!a.canDelete()})}),a.addWorkflowObject=function(b){return e.addWorkflowObject(b,a)},a.copy=function(){console.log("Copy")},a.canDelete=function(){return null!==e.getFirstSelectedItem(a)},a["delete"]=function(){e.deleteSelectedObjects(a)},a.paste=function(){console.log("Paste")},a.save=function(){console.log(a.canvasDetails.kineticStageObj.find("#mainLayer")[0].toJSON())},a.load=function(){e.loadFromDefinition(a,'{"attrs":{"id":"mainLayer"},"id":3,"className":"Layer","children":[{"attrs":{"x":298,"y":205.5,"points":[0,0,75,0,62.00961894323342,7.499999999999999,75,0,62.00961894323342,-7.499999999999999],"stroke":"black","originalStrokeWidth":2,"connectors":{"start":{"id":9},"end":{"id":13}},"label":{"id":18},"element":{"id":"During","uri":"http://rdf.healthit.gov/qdm/element#During","name":"During","type":"TemporalOperator","children":[]}},"id":17,"className":"PhemaConnection"},{"attrs":{"x":298,"y":210.5,"width":75,"fontFamily":"Calibri","fill":"black","text":"During","align":"center","height":"auto"},"id":18,"className":"Text"},{"attrs":{"draggable":true,"x":123,"y":118,"phemaObject":{"className":"TemporalOperator"},"width":425,"height":175,"element":{"id":"During","uri":"http://rdf.healthit.gov/qdm/element#During","name":"During","type":"TemporalOperator","children":[]}},"id":6,"className":"PhemaGroup","children":[{"attrs":{"width":175,"height":175,"fill":"white","name":"eventA","stroke":"gray","strokeWidth":1,"dash":[10,5]},"id":7,"className":"Rect"},{"attrs":{"y":87.5,"radius":7.5,"fill":"white","name":"leftConnector","stroke":"black","strokeWidth":1,"connections":[]},"id":8,"className":"PhemaConnector"},{"attrs":{"x":175,"y":87.5,"radius":7.5,"fill":"white","name":"rightConnector","stroke":"black","strokeWidth":1,"connections":[{"id":17}]},"id":9,"className":"PhemaConnector"},{"attrs":{"width":175,"fontFamily":"Calibri","fontSize":18,"fill":"black","text":"Event A","name":"eventALabel","align":"center","padding":5,"height":"auto"},"id":10,"className":"Text"},{"attrs":{"y":53,"width":175,"fontFamily":"Calibri","fontSize":14,"fill":"black","name":"eventAText","text":"(Drag and drop a data element here to define the event)","align":"center","padding":5,"height":"auto"},"id":11,"className":"Text"},{"attrs":{"x":250,"width":175,"height":175,"fill":"white","name":"eventB","stroke":"gray","strokeWidth":1,"dash":[10,5]},"id":12,"className":"Rect"},{"attrs":{"x":250,"y":87.5,"radius":7.5,"fill":"white","name":"leftConnector","stroke":"black","strokeWidth":1,"connections":[{"id":17}]},"id":13,"className":"PhemaConnector"},{"attrs":{"x":425,"y":87.5,"radius":7.5,"fill":"white","name":"rightConnector","stroke":"black","strokeWidth":1,"connections":[]},"id":14,"className":"PhemaConnector"},{"attrs":{"x":250,"width":175,"fontFamily":"Calibri","fontSize":18,"fill":"black","text":"Event B","name":"eventBLabel","align":"center","padding":5,"height":"auto"},"id":15,"className":"Text"},{"attrs":{"x":250,"y":53,"width":175,"fontFamily":"Calibri","fontSize":14,"fill":"black","name":"eventBText","text":"(Drag and drop a data element here to define the event)","align":"center","padding":5,"height":"auto"},"id":16,"className":"Text"}]}]}')},a.buttons=[{text:"Save",iconClass:"fa fa-save",event:a.save},{text:"Load",iconClass:"fa fa-folder-open",event:a.load},{text:"Export",iconClass:"fa fa-arrow-circle-down"},{spacer:!0},{text:"Copy",iconClass:"fa fa-copy",event:a.copy},{text:"Paste",iconClass:"fa fa-paste",event:a.paste},{text:"Undo",iconClass:"fa fa-undo"},{text:"Redo",iconClass:"fa fa-repeat"}],a.canShowProperties=function(b){var c=b||e.getFirstSelectedItem(a);if(!c||!c.element)return!1;var d=c.element();return"TemporalOperator"===d.type||"LogicalOperator"===d.type||"Category"===d.type||"DataElement"===d.type},a.showProperties=function(){var b=e.getFirstSelectedItem(a);if(a.canShowProperties(b)){var c=null,f=b.element();"TemporalOperator"===f.type?(c=d.open({templateUrl:"views/properties/relationship.html",controller:"RelationshipPropertiesController",size:"lg",resolve:{element:function(){return angular.copy(f)},temporalOperators:function(){return a.temporalOperators}}}),c.result.then(function(c){var d=c.relationship.modifier?c.relationship.modifier.id:c.relationship.base.uri;f.uri=d,f.name=ArrayUtil.findInArrayOrChildren(a.temporalOperators,"uri",d).name,f.timeRange=c.timeRange,c.timeRange.comparison&&(f.timeRange.comparison=c.timeRange.comparison.name);var e=b.label();e.setText(f.name),e.getStage().draw()})):"LogicalOperator"===f.type?(c=d.open({templateUrl:"views/properties/logicalOperator.html",controller:"LogicalOperatorPropertiesController",size:"lg",resolve:{element:function(){return angular.copy(f)},containedElements:function(){return b.phemaObject().containedElements()},logicalOperators:function(){return a.logicalOperators}}}),c.result.then(function(a){f=a,findParentElementByName(b,"header").setText(f.name),b.getStage().draw()})):("Category"===f.type||"DataElement"===f.type)&&(c=d.open({templateUrl:"views/properties/qdmElement.html",controller:"QDMElementPropertiesController",size:"lg",resolve:{element:function(){return angular.copy(f)}}}),c.result.then(function(a){f.attributes=a}))}}}]),angular.module("security.login.form",[]).controller("LoginFormController",["$scope","security",function(a,b){a.user={},a.authError=null,a.authReason=null,b.getLoginReason()&&(a.authReason=b.isAuthenticated()?"You are not authorized to access this page":"Please log in to continue"),a.login=function(){a.authError=null,b.login(a.user.email,a.user.password).then(function(b){b||(a.authError="Invalid login or password")},function(b){a.authError=b})},a.clearForm=function(){a.user={}},a.cancelLogin=function(){b.cancelLogin()}}]),angular.module("sopheAuthorApp").controller("DashboardController",["$scope",function(a){a.newsItems=[],a.phenotypes=[]}]),angular.module("sopheAuthorApp").controller("RelationshipPropertiesController",["$scope","$modalInstance","TemporalOperatorService","element","temporalOperators",function(a,b,c,d,e){a.element=d,a.relationship={relationship:{base:"",modifier:"",value:d.uri},timeRange:{comparison:"",start:{value:"",units:""},end:{value:"",units:""}}},a.units=[{name:"minutes",value:"m"},{name:"hours",value:"h"},{name:"days",value:"d"},{name:"weeks",value:"wk"},{name:"months",value:"mo"},{name:"years",value:"a"}],a.comparisons=[{name:"at any time",showStartTime:!1,showEndTime:!1},{name:"between",showStartTime:!0,showEndTime:!0},{name:"exactly",showStartTime:!0,showEndTime:!1},{name:">=",showStartTime:!0,showEndTime:!1},{name:">",showStartTime:!0,showEndTime:!1},{name:"<=",showStartTime:!0,showEndTime:!1},{name:"<",showStartTime:!0,showEndTime:!1}],a.relationships=c.buildRelationshipListForProperties(e);var f=c.convertQDMToSoPhe(d.uri,e);null!=f&&(a.relationship.relationship.base=ArrayUtil.findInArray(a.relationships,"id",f.base),a.relationship.relationship.modifier=ArrayUtil.findInArray(a.relationship.relationship.base.modifiers,"label",f.modifier)),d.timeRange&&(a.relationship.timeRange=d.timeRange,a.relationship.timeRange.comparison=ArrayUtil.findInArray(a.comparisons,"name",d.timeRange.comparison)),a.ok=function(){b.close(a.relationship)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("sopheAuthorApp").controller("LogicalOperatorPropertiesController",["$scope","$modalInstance","LogicalOperatorService","element","containedElements","logicalOperators",function(a,b,c,d,e,f){a.logicalOperators=f,c.addDescriptionForProperties(a.logicalOperators),a.logicalOperator=ArrayUtil.findInArray(a.logicalOperators,"name",d.name),a.containedElements=e,a.ok=function(){b.close(a.logicalOperator)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("sopheAuthorApp").controller("QDMElementPropertiesController",["$scope","$modalInstance","QDMElementService","QDMAttributeService","element",function(a,b,c,d,e){a.element=e,a.formData=e.attributes||{},a.formTemplate={promise:c.getAttributes(e).then(function(a){for(var b=[],c=0;c<a.length;c++)b.push(d.translateQDMToForm(a[c]));return b})},a.ok=function(){console.log(a.formData),b.close(a.formData)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("security",["security.service","security.interceptor","security.login","security.authorization"]),angular.module("security.interceptor",["security.retryQueue"]).factory("securityInterceptor",["$injector","securityRetryQueue",function(a,b){return function(c){return c.then(null,function(d){return 401===d.status&&(c=b.pushRetryFn("unauthorized-server",function(){return a.get("$http")(d.config)})),c})}}]).config(["$httpProvider",function(a){a.responseInterceptors.push("securityInterceptor")}]),angular.module("security.retryQueue",[]).factory("securityRetryQueue",["$q","$log",function(a,b){var c=[],d={onItemAddedCallbacks:[],hasMore:function(){return c.length>0},push:function(a){c.push(a),angular.forEach(d.onItemAddedCallbacks,function(c){try{c(a)}catch(d){b.error("securityRetryQueue.push(retryItem): callback threw an error"+d)}})},pushRetryFn:function(b,c){1===arguments.length&&(c=b,b=void 0);var e=a.defer(),f={reason:b,retry:function(){a.when(c()).then(function(a){e.resolve(a)},function(a){e.reject(a)})},cancel:function(){e.reject()}};return d.push(f),e.promise},retryReason:function(){return d.hasMore()&&c[0].reason},cancelAll:function(){for(;d.hasMore();)c.shift().cancel()},retryAll:function(){for(;d.hasMore();)c.shift().retry()}};return d}]),angular.module("security.service",["security.retryQueue","security.login","ui.bootstrap.modal"]).factory("security",["$http","$q","$location","securityRetryQueue","$modal",function(a,b,c,d,e){function f(a){a=a||"/",c.path(a)}function g(){j||(j=e.open({templateUrl:"views/security/login.html",controller:"LoginFormController"}),j.result.then(i))}function h(a){j&&(j.close(a),j=null)}function i(a){a?d.retryAll():(d.cancelAll(),f())}var j=null;d.onItemAddedCallbacks.push(function(){d.hasMore()&&k.showLogin()});var k={getLoginReason:function(){return d.retryReason()},showLogin:function(){g()},login:function(b,c){var d=a.post("/login",{email:b,password:c});return d.then(function(a){k.currentUser=a.data.user,k.isAuthenticated()&&h(!0)})},cancelLogin:function(){h(!1),f()},logout:function(b){a.post("/logout").then(function(){k.currentUser=null,f(b)})},requestCurrentUser:function(){return k.isAuthenticated()?b.when(k.currentUser):a.get("/current-user").then(function(a){return k.currentUser=a.data.user,k.currentUser})},currentUser:null,isAuthenticated:function(){return null==k.currentUser&&(k.currentUser={firstName:"Test",lastName:"Person"}),!!k.currentUser},isAdmin:function(){return!(!k.currentUser||!k.currentUser.admin)}};return k}]),angular.module("security.authorization",["security.service"]).provider("securityAuthorization",{requireAdminUser:["securityAuthorization",function(a){return a.requireAdminUser()}],requireAuthenticatedUser:["securityAuthorization",function(a){return a.requireAuthenticatedUser()}],$get:["security","securityRetryQueue",function(a,b){var c={requireAuthenticatedUser:function(){var d=a.requestCurrentUser().then(function(){return a.isAuthenticated()?void 0:b.pushRetryFn("unauthenticated-client",c.requireAuthenticatedUser)});return d},requireAdminUser:function(){var d=a.requestCurrentUser().then(function(){return a.isAdmin()?void 0:b.pushRetryFn("unauthorized-client",c.requireAdminUser)});return d}};return c}]}),angular.module("security.login",["security.login.form","security.login.toolbar"]),angular.module("security.login.toolbar",[]).directive("loginToolbar",["security",function(a){var b={templateUrl:"views/security/toolbar.html",restrict:"E",replace:!0,scope:!0,link:function(b){b.isAuthenticated=a.isAuthenticated,b.login=a.showLogin,b.logout=a.logout,b.$watch(function(){return a.currentUser},function(a){b.currentUser=a})}};return b}]);